<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jaume Amores">
<meta name="dcterms.date" content="2024-03-22">

<title>Jaume Amores - Hello World AML pipeline with component</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jaume Amores - Hello World AML pipeline with component">
<meta property="og:description" content="Exploring AML through Hello World components.">
<meta property="og:site_name" content="Jaume Amores">
<meta property="og:locale" content="en_US">
<meta name="twitter:title" content="Jaume Amores - Hello World AML pipeline with component">
<meta name="twitter:description" content="Exploring AML through Hello World components.">
<meta name="twitter:creator" content="@JaumeEire">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jaume Amores</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../papers.pdf"> 
<span class="menu-text">Papers</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#hello-world-aml-pipeline-with-components" id="toc-hello-world-aml-pipeline-with-components" class="nav-link active" data-scroll-target="#hello-world-aml-pipeline-with-components">Hello World AML pipeline with components</a>
  <ul class="collapse">
  <li><a href="#starting-development-with-a-notebook" id="toc-starting-development-with-a-notebook" class="nav-link" data-scroll-target="#starting-development-with-a-notebook">Starting development with a notebook</a>
  <ul class="collapse">
  <li><a href="#adding-logs-with-mlflow" id="toc-adding-logs-with-mlflow" class="nav-link" data-scroll-target="#adding-logs-with-mlflow">Adding logs with MLflow</a></li>
  </ul></li>
  <li><a href="#running-script-as-a-job" id="toc-running-script-as-a-job" class="nav-link" data-scroll-target="#running-script-as-a-job">Running script as a job</a>
  <ul class="collapse">
  <li><a href="#importing-required-modules" id="toc-importing-required-modules" class="nav-link" data-scroll-target="#importing-required-modules">Importing required modules</a></li>
  <li><a href="#setting-connection" id="toc-setting-connection" class="nav-link" data-scroll-target="#setting-connection">Setting connection</a></li>
  <li><a href="#specifying-and-submitting-job" id="toc-specifying-and-submitting-job" class="nav-link" data-scroll-target="#specifying-and-submitting-job">Specifying and submitting job</a></li>
  <li><a href="#changing-the-input" id="toc-changing-the-input" class="nav-link" data-scroll-target="#changing-the-input">Changing the input</a></li>
  </ul></li>
  <li><a href="#creating-single-component-pipeline" id="toc-creating-single-component-pipeline" class="nav-link" data-scroll-target="#creating-single-component-pipeline">Creating single component pipeline</a>
  <ul class="collapse">
  <li><a href="#adding-an-input" id="toc-adding-an-input" class="nav-link" data-scroll-target="#adding-an-input">Adding an input</a></li>
  <li><a href="#using-uri_file-as-input" id="toc-using-uri_file-as-input" class="nav-link" data-scroll-target="#using-uri_file-as-input">Using uri_file as input</a></li>
  <li><a href="#adding-an-output" id="toc-adding-an-output" class="nav-link" data-scroll-target="#adding-an-output">Adding an output</a></li>
  </ul></li>
  <li><a href="#pipeline-with-two-components" id="toc-pipeline-with-two-components" class="nav-link" data-scroll-target="#pipeline-with-two-components">Pipeline with two components</a>
  <ul class="collapse">
  <li><a href="#make-subfolders-and-create-dummy-data" id="toc-make-subfolders-and-create-dummy-data" class="nav-link" data-scroll-target="#make-subfolders-and-create-dummy-data">Make subfolders and create dummy data</a></li>
  <li><a href="#preprocessing-component" id="toc-preprocessing-component" class="nav-link" data-scroll-target="#preprocessing-component">Preprocessing component</a></li>
  <li><a href="#training-component" id="toc-training-component" class="nav-link" data-scroll-target="#training-component">Training component</a></li>
  <li><a href="#testing-the-pipeline" id="toc-testing-the-pipeline" class="nav-link" data-scroll-target="#testing-the-pipeline">Testing the pipeline</a></li>
  <li><a href="#pipeline" id="toc-pipeline" class="nav-link" data-scroll-target="#pipeline">Pipeline</a></li>
  </ul></li>
  <li><a href="#using-uri_folder" id="toc-using-uri_folder" class="nav-link" data-scroll-target="#using-uri_folder">Using uri_folder</a>
  <ul class="collapse">
  <li><a href="#main-differences" id="toc-main-differences" class="nav-link" data-scroll-target="#main-differences">Main differences</a></li>
  <li><a href="#preprocessing-component-1" id="toc-preprocessing-component-1" class="nav-link" data-scroll-target="#preprocessing-component-1">Preprocessing component</a></li>
  <li><a href="#training-component-1" id="toc-training-component-1" class="nav-link" data-scroll-target="#training-component-1">Training component</a></li>
  <li><a href="#testing-the-pipeline-1" id="toc-testing-the-pipeline-1" class="nav-link" data-scroll-target="#testing-the-pipeline-1">Testing the pipeline</a></li>
  <li><a href="#pipeline-1" id="toc-pipeline-1" class="nav-link" data-scroll-target="#pipeline-1">Pipeline</a></li>
  </ul></li>
  <li><a href="#pipeline-with-three-components" id="toc-pipeline-with-three-components" class="nav-link" data-scroll-target="#pipeline-with-three-components">Pipeline with three components</a>
  <ul class="collapse">
  <li><a href="#preparing-data" id="toc-preparing-data" class="nav-link" data-scroll-target="#preparing-data">Preparing data</a></li>
  <li><a href="#preprocessing-component-2" id="toc-preprocessing-component-2" class="nav-link" data-scroll-target="#preprocessing-component-2">Preprocessing component</a></li>
  <li><a href="#inference-component" id="toc-inference-component" class="nav-link" data-scroll-target="#inference-component">Inference component</a></li>
  <li><a href="#testing-the-pipeline-2" id="toc-testing-the-pipeline-2" class="nav-link" data-scroll-target="#testing-the-pipeline-2">Testing the pipeline</a></li>
  <li><a href="#pipeline-2" id="toc-pipeline-2" class="nav-link" data-scroll-target="#pipeline-2">Pipeline</a></li>
  </ul></li>
  <li><a href="#refactoring" id="toc-refactoring" class="nav-link" data-scroll-target="#refactoring">Refactoring</a>
  <ul class="collapse">
  <li><a href="#style-guide" id="toc-style-guide" class="nav-link" data-scroll-target="#style-guide">Style guide</a></li>
  </ul></li>
  <li><a href="#final-pipeline" id="toc-final-pipeline" class="nav-link" data-scroll-target="#final-pipeline">Final pipeline</a>
  <ul class="collapse">
  <li><a href="#preprocessing-component-3" id="toc-preprocessing-component-3" class="nav-link" data-scroll-target="#preprocessing-component-3">Preprocessing component</a></li>
  <li><a href="#training-component-2" id="toc-training-component-2" class="nav-link" data-scroll-target="#training-component-2">Training component</a></li>
  <li><a href="#inference-component-1" id="toc-inference-component-1" class="nav-link" data-scroll-target="#inference-component-1">Inference component</a></li>
  <li><a href="#testing-the-pipeline-3" id="toc-testing-the-pipeline-3" class="nav-link" data-scroll-target="#testing-the-pipeline-3">Testing the pipeline</a></li>
  <li><a href="#pipeline-3" id="toc-pipeline-3" class="nav-link" data-scroll-target="#pipeline-3">Pipeline</a></li>
  </ul></li>
  <li><a href="#putting-everything-into-a-script" id="toc-putting-everything-into-a-script" class="nav-link" data-scroll-target="#putting-everything-into-a-script">Putting everything into a script</a>
  <ul class="collapse">
  <li><a href="#config-json-file" id="toc-config-json-file" class="nav-link" data-scroll-target="#config-json-file">config json file</a></li>
  <li><a href="#pipeline-script" id="toc-pipeline-script" class="nav-link" data-scroll-target="#pipeline-script">pipeline script</a></li>
  <li><a href="#removing-global-variables" id="toc-removing-global-variables" class="nav-link" data-scroll-target="#removing-global-variables">Removing global variables</a></li>
  </ul></li>
  <li><a href="#indicating-environment-and-compute-instance" id="toc-indicating-environment-and-compute-instance" class="nav-link" data-scroll-target="#indicating-environment-and-compute-instance">Indicating environment and compute instance</a>
  <ul class="collapse">
  <li><a href="#aml-utils" id="toc-aml-utils" class="nav-link" data-scroll-target="#aml-utils">AML Utils</a></li>
  <li><a href="#config-file" id="toc-config-file" class="nav-link" data-scroll-target="#config-file">Config file</a></li>
  <li><a href="#pipeline-script-1" id="toc-pipeline-script-1" class="nav-link" data-scroll-target="#pipeline-script-1">Pipeline script</a></li>
  </ul></li>
  <li><a href="#with-closure" id="toc-with-closure" class="nav-link" data-scroll-target="#with-closure">With closure</a>
  <ul class="collapse">
  <li><a href="#debugging" id="toc-debugging" class="nav-link" data-scroll-target="#debugging">Debugging</a></li>
  </ul></li>
  <li><a href="#further-refactorings" id="toc-further-refactorings" class="nav-link" data-scroll-target="#further-refactorings">Further refactorings</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hello World AML pipeline with component</h1>
<p class="subtitle lead">Exploring AML through Hello World components.</p>
  <div class="quarto-categories">
    <div class="quarto-category">Data Science</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jaume Amores </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 22, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="hello-world-aml-pipeline-with-components" class="level1">
<h1>Hello World AML pipeline with components</h1>
<p>The purpose of this tutorial is to show how to incrementally build a pipeline from simple and debuggable “Hello World” components. In order to run this at home, you may find it useful to create a free Azure ML subscription as described in the how-to guide I have <a href="../../additional/data_science/aml/free_subscription.html">here</a></p>
<section id="starting-development-with-a-notebook" class="level2">
<h2 class="anchored" data-anchor-id="starting-development-with-a-notebook">Starting development with a notebook</h2>
<p>In this section, we will write our code in a notebook and make sure it works well. Then, we will convert it to a script and run it from the terminal. Finally, we will add some logs with MLFlow.</p>
<p>Although not required, as a very first step we can create a environment and kernel following the tutorial in https://learn.microsoft.com/en-gb/azure/machine-learning/tutorial-cloud-workstation?view=azureml-api-2</p>
<p>Following the previous tutorial, create a notebook and type the following hello world code:</p>
<div id="b4a67b25-46e9-40af-8755-35c548160a3b" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world (name):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Greets the indicated person and the world in general."""</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"Hello </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> and world"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>hello_world (<span class="st">"Jaume"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hello Jaume and world</code></pre>
</div>
</div>
<p>Fantastic, the code works ;-). Now, let’s convert it to a script that can be run from terminal. The tutorial above explains how to convert the notebook to a python file. In our case, we will first add an argument parser and then write it to file using the magic cell <code>%%writefile</code></p>
<div id="0b2a7fdb-b52f-4240-a031-c6bd8bfb886f" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world_core.py</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world (name):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Greets the indicated person and the world in general."""</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"Hello </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> and world"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--name"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"person to greet"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    hello_world (args.name)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing hello_world_core.py</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Bad pipe message: %s [b'\x80\xb8\xc2\x0e\x1b\xcd4\xe90\x12O\x89\xff4\x0b\xbf;\xab \xb6*\xd3\xab\x91\xb6\x87\xe82s\x1fIv\xd3\x172\xa6\x11\xb2w\xff\xf2\x02L\xbf_\xc1\t\x1dn\xdc\x0f\x00\x08\x13\x02\x13\x03\x13\x01\x00\xff\x01\x00\x00\x8f\x00\x00\x00\x0e\x00\x0c\x00\x00\t127.0.0.1\x00\x0b\x00\x04\x03\x00\x01\x02\x00\n\x00\x0c\x00\n\x00\x1d\x00\x17\x00\x1e\x00\x19\x00\x18\x00#\x00\x00\x00\x16\x00\x00\x00\x17\x00\x00\x00\r\x00\x1e\x00\x1c\x04\x03\x05\x03\x06\x03\x08\x07\x08\x08\x08\t\x08\n\x08\x0b\x08\x04\x08\x05\x08\x06\x04\x01\x05\x01\x06\x01\x00+\x00\x03\x02\x03\x04\x00-\x00\x02']
Bad pipe message: %s [b'4\xf9%\x9at\xbe\x08\x03\x06\xf5.E\xe9\xd7\xb3\xa1Z\x8d ']
Bad pipe message: %s [b'\x0c5\x85\xf5Z']
Bad pipe message: %s [b'\xe3\x18^', b'\x9cOo\xfe*\xa90\xa3\xf8\xfa#\x8d\x0b\x00\x00\xa2\xc0\x14\xc0\n\x009\x008\x007\x006\x00\x88\x00\x87\x00\x86\x00\x85\xc0\x19\x00:\x00\x89\xc0\x0f\xc0\x05\x005\x00\x84\xc0\x13\xc0\t\x003\x002\x001\x000\x00\x9a\x00\x99\x00\x98\x00\x97\x00E\x00D\x00C\x00B\xc0\x18\x004\x00\x9b\x00F\xc0\x0e\xc0\x04\x00/\x00\x96\x00A\x00\x07\xc0\x11\xc0\x07\xc0\x16\x00\x18\xc0\x0c\xc0\x02\x00\x05\x00\x04\xc0\x12\xc0\x08\x00\x16\x00\x13\x00\x10\x00\r\xc0\x17\x00\x1b\xc0\r\xc0\x03\x00\n\x00\x15\x00\x12\x00\x0f\x00\x0c\x00\x1a\x00\t\x00\x14\x00\x11\x00\x19\x00\x08\x00\x06\x00\x17\x00\x03\xc0\x10\xc0\x06\xc0\x15\xc0\x0b\xc0\x01\x00\x02\x00\x01\x00\xff\x02\x01\x00\x00C\x00\x00\x00\x0e\x00\x0c\x00\x00\t127.0.0.1\x00\x0b\x00\x04\x03\x00\x01\x02\x00\n\x00\x1c\x00\x1a\x00\x17\x00\x19\x00\x1c\x00\x1b\x00\x18\x00\x1a\x00\x16\x00\x0e\x00\r']
Bad pipe message: %s [b"\x85c}\xe4\x85\xb5*i\xf3vog\x0b\x16\\\xdd\x9e\x0e\x00\x00\x86\xc00\xc0,\xc0(\xc0$\xc0\x14\xc0\n\x00\xa5\x00\xa3\x00\xa1\x00\x9f\x00k\x00j\x00i\x00h\x009\x008\x007\x006\xc02\xc0.\xc0*\xc0&amp;\xc0\x0f\xc0\x05\x00\x9d\x00=\x005\xc0/\xc0+\xc0'\xc0#\xc0\x13\xc0\t\x00\xa4\x00\xa2\x00\xa0\x00\x9e\x00g\x00@\x00?\x00&gt;\x003\x00", b'1\x000\xc01\xc0-\xc0)\xc0%\xc0\x0e\xc0\x04\x00\x9c\x00&lt;\x00/\x00\x9a\x00\x99\x00\x98\x00\x97\x00\x96\x00\x07\xc0\x11\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\x00\xff\x02\x01']
Bad pipe message: %s [b"\xf3\x03\x81E\x16\x17\x18\x1e0(\xa5\x94\x96\x98\x0cw\xd6\xe3\x00\x00\xf4\xc00\xc0,\xc0(\xc0$\xc0\x14\xc0\n\x00\xa5\x00\xa3\x00\xa1\x00\x9f\x00k\x00j\x00i\x00h\x009\x008\x007\x006\x00\x88\x00\x87\x00\x86\x00\x85\xc0\x19\x00\xa7\x00m\x00:\x00\x89\xc02\xc0.\xc0*\xc0&amp;\xc0\x0f\xc0\x05\x00\x9d\x00=\x005\x00\x84\xc0/\xc0+\xc0'\xc0#\xc0\x13\xc0\t\x00\xa4\x00\xa2\x00\xa0\x00\x9e\x00g\x00@\x00?\x00&gt;\x003\x002\x001\x000\x00\x9a\x00\x99\x00\x98\x00\x97\x00E\x00D\x00C\x00B\xc0\x18\x00\xa6\x00l\x004\x00\x9b\x00F\xc01\xc0-\xc0)\xc0%\xc0\x0e\xc0\x04\x00\x9c\x00&lt;\x00", b'\x96\x00A\x00\x07\xc0\x11\xc0\x07\xc0\x16\x00\x18\xc0\x0c\xc0\x02\x00\x05\x00\x04\xc0\x12\xc0\x08\x00\x16\x00\x13\x00\x10\x00\r\xc0\x17\x00\x1b\xc0\r\xc0\x03\x00\n\x00\x15\x00']
Bad pipe message: %s [b'\x0f\x00\x0c\x00\x1a\x00\t\x00\x14\x00\x11\x00\x19\x00\x08\x00\x06']</code></pre>
</div>
</div>
<p>Now, we can open up a terminal, as illustrated in the tutorial above, cd to the folder where the script is and run it:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  Users/<span class="op">&lt;</span>my_user<span class="op">&gt;</span>/hello_world</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> hello_world_core.py <span class="at">--name</span> Jaume</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="adding-logs-with-mlflow" class="level3">
<h3 class="anchored" data-anchor-id="adding-logs-with-mlflow">Adding logs with MLflow</h3>
<div id="fc48978f-363a-482e-a4d3-57d85c315243" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world_with_logs.py</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hello_world_core <span class="im">import</span> hello_world, parse_args</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_logging (args):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set name for logging</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="st">"Hello World with logging"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    mlflow.start_run()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param (<span class="st">"name to log"</span>, args.name)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> finish_logging ():</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    mlflow.end_run ()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    start_logging (args)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    hello_world (args.name)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    finish_logging ()</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting hello_world_with_logs.py</code></pre>
</div>
</div>
<p>Let’s run it and see:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> hello_world_with_logs.py <span class="at">--name</span> Peter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here is the newly created job:</p>
<p><img src="hello_world_files/figure-html/bb15d35a-4ea8-49ed-82ce-c015ee4e827d-1-13fdea7e-2c7a-4ec8-ad33-fb8013635d3c.png" class="img-fluid"></p>
<p>And the name passed as argument:</p>
<p><img src="hello_world_files/figure-html/a1577977-2631-4a28-a2d8-d2d2a76c1c41-1-4f6bb75d-9e6f-49e6-8bcf-19fe7448e5d4.png" class="img-fluid"></p>
<p>We start by getting a connection to our Azure ML (AML for short) workspace. We use here a simple connection mechanism that doesn’t require writting your subscription, resource group and workspace details:</p>
<div id="794b917b-a4aa-430a-96b2-cd375a0efe97" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> MLClient</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># authenticate</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a handle to the workspace</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>ml_client <span class="op">=</span> MLClient.from_config (</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    credential<span class="op">=</span>credential</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found the config file in: /config.json</code></pre>
</div>
</div>
</section>
</section>
<section id="running-script-as-a-job" class="level2">
<h2 class="anchored" data-anchor-id="running-script-as-a-job">Running script as a job</h2>
<p>We now convert the previous script into a job that can be run from the UI.</p>
<section id="importing-required-modules" class="level3">
<h3 class="anchored" data-anchor-id="importing-required-modules">Importing required modules</h3>
<div id="66157643-50ee-4366-9ad3-5496500082c9" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Third-party imports</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># AML imports</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> (</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    command,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    dsl,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    Input,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    Output,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    MLClient</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity <span class="im">import</span> DefaultAzureCredential</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-connection" class="level3">
<h3 class="anchored" data-anchor-id="setting-connection">Setting connection</h3>
<p>For the remaining part of this tutorial, we will be needing an <code>ml_client</code> handle. This will allow us to create and use resources from our workspace. The simplest way to get such handle is with the following code:</p>
<div id="904b3dc3-4abf-4509-8874-52e5c9f9600d" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># authenticate</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a handle to the workspace</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ml_client <span class="op">=</span> MLClient.from_config (</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    credential<span class="op">=</span>credential</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found the config file in: /config.json</code></pre>
</div>
</div>
</section>
<section id="specifying-and-submitting-job" class="level3">
<h3 class="anchored" data-anchor-id="specifying-and-submitting-job">Specifying and submitting job</h3>
<p>We specify a job using the <code>command</code> decorator:</p>
<div id="2ee8efea-d7f4-4a5c-9d60-010fcd9bfdd1" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> command(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"Jaume"</span>, <span class="co"># default value of our parameter</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python hello_world_core.py --name $</span><span class="sc">{{</span><span class="st">inputs.name</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Simplest Hello World"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Note: we indicate as environment “AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest”, which actually contains more libraries than we need, such as sklearn. Simpler environments to use can be found in the “Environments” section of the workspace.</p>
</blockquote>
<p>… and submit it using <code>create_or_update</code> from <code>ml_client</code>:</p>
<div id="8184260b-bc9a-4dd8-a916-e593d4590d6d" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ml_client.create_or_update(job)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Class AutoDeleteSettingSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class AutoDeleteConditionSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class BaseAutoDeleteSettingSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class IntellectualPropertySchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class ProtectionLevelSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class BaseIntellectualPropertySchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Uploading hello_world (8.59 MBs): 100%|██████████| 8591281/8591281 [00:00&lt;00:00, 40584539.30it/s]

</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Experiment</td>
<td data-quarto-table-cell-role="th">Name</td>
<td data-quarto-table-cell-role="th">Type</td>
<td data-quarto-table-cell-role="th">Status</td>
<td data-quarto-table-cell-role="th">Details Page</td>
</tr>
<tr class="even">
<td>hello_world</td>
<td>clever_spade_sq4jwcg67r</td>
<td>command</td>
<td>Starting</td>
<td><a href="https://ml.azure.com/runs/clever_spade_sq4jwcg67r?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld&amp;tid=369b25b1-777a-484a-8b5b-52d79bc83015" target="_blank" rel="noopener">Link to Azure Machine Learning studio</a></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In the link that appears, we can see the status of the job, which initially is “Queued”. We need to wait until it is completed (and refresh the page to see this). Once it is completed, we can look at the logs:</p>
<p><img src="hello_world_files/figure-html/2cfb025b-128c-4db6-9938-7b213f4da644-1-c5981c58-f7fe-4403-ac33-a2815c5fefaf.png" class="img-fluid"></p>
<p>In the logs, we can see the messages printed in console:</p>
<p><img src="hello_world_files/figure-html/e0f6699a-8753-4896-af57-5339ea24f2ed-1-db1421a5-9a86-413a-9efe-d8c8c2b892aa.png" class="img-fluid"></p>
</section>
<section id="changing-the-input" class="level3">
<h3 class="anchored" data-anchor-id="changing-the-input">Changing the input</h3>
<p>Above, we indicated a default value for the input argument <code>name</code>. It would be good to be able to submit jobs with different values for that argument. One way to do that is:</p>
<ul>
<li>In the job’s <em>Overview</em> tab, click on “Edit and submit”</li>
</ul>
<p><img src="hello_world_files/figure-html/5d2c9a0e-6d2f-445f-871d-3a6896a52495-1-649f8bac-3c6e-4649-adc9-e69be6f2964d.png" class="img-fluid"></p>
<ul>
<li>In the “Training script” section, edit the “Inputs” by clicking on the pencil next to it:</li>
</ul>
<p><img src="hello_world_files/figure-html/a6035d31-cf69-4892-96c5-442c60402617-1-f770aca0-b348-4ad0-aa33-d045d53719bc.png" class="img-fluid"></p>
<ul>
<li>In the “Input value” field, type the new value you want for the argument:</li>
</ul>
<p><img src="hello_world_files/figure-html/f9a0a63e-856e-44a0-8e2f-6347491133db-1-1183eecd-be78-4990-8ed1-215b2d8d84b2.png" class="img-fluid"></p>
<ul>
<li><p>Hit Next several times and then Submit.</p></li>
<li><p>If we go to the jobs section of the workspace, and enter again our job (“helloworld”), we can see that a new job has been submitted:</p></li>
</ul>
<p><img src="hello_world_files/figure-html/f3cbea29-9416-4042-91ce-284629f22066-1-e0762b12-8ca2-45bf-98c4-fa84db5a91d4.png" class="img-fluid"></p>
<p>In its Overview tab, under “See all properties”, we can inspect the json file:</p>
<p><img src="hello_world_files/figure-html/f7fad0a5-1d87-4d0b-85f9-90c4eac1dc85-1-62dc8e0a-b5e5-466e-a2e4-baba287d5b94.png" class="img-fluid"></p>
<p>… and see that the new value (Peter) is used in its “parameters” dictionary:</p>
<p><img src="hello_world_files/figure-html/7f4a26b1-ad9f-4939-af0c-f78785720cf6-1-1f40b6df-d4e7-43b8-ae12-215dd331b04f.png" class="img-fluid"></p>
<p>The std_log.txt for this job shows the new message with Peter:</p>
<p><img src="hello_world_files/figure-html/bb51423a-8e0c-4fde-9fbe-409c014c70f7-1-13d83f23-87f8-4a3d-b38b-b1e4f14834e1.png" class="img-fluid"></p>
</section>
</section>
<section id="creating-single-component-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="creating-single-component-pipeline">Creating single component pipeline</h2>
<div id="08db4dd6-a562-4c1f-ad7e-375564f09288" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>hello_world_component <span class="op">=</span> ml_client.create_or_update(job.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading hello_world (8.58 MBs): 100%|██████████| 8578531/8578531 [00:00&lt;00:00, 21700197.27it/s]

</code></pre>
</div>
</div>
<div id="b3c3df45-e03e-4e0f-b753-e8d5be1dab5b" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the dsl decorator tells the sdk that we are defining an Azure Machine Learning pipeline</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world_pipeline(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input: <span class="bu">str</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Hello World pipeline</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_input: str</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Input to pipeline, here name of person to greed.</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    hello_world_job <span class="op">=</span> hello_world_component(</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>pipeline_job_input,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="431f9e20-53a9-4468-af9d-f05d85e17162" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's instantiate the pipeline with the parameters of our choice</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> hello_world_pipeline(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input<span class="op">=</span><span class="st">"David"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c79ff2bb-7e75-4aba-a1c1-d6e577e764f6" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    pipeline,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_registered_components"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Class AutoDeleteSettingSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class AutoDeleteConditionSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class BaseAutoDeleteSettingSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class IntellectualPropertySchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class ProtectionLevelSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class BaseIntellectualPropertySchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: shy_cabbage_xb9vv4fswl
Web View: https://ml.azure.com/runs/shy_cabbage_xb9vv4fswl?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-26 14:08:19Z] Submitting 1 runs, first five are: 605cf9a7:d9904e2d-3ecb-4ddc-a04d-e2fed4facfe6
[2024-03-26 14:12:40Z] Completing processing run id d9904e2d-3ecb-4ddc-a04d-e2fed4facfe6.

Execution Summary
=================
RunId: shy_cabbage_xb9vv4fswl
Web View: https://ml.azure.com/runs/shy_cabbage_xb9vv4fswl?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p><img src="hello_world_files/figure-html/f0600250-c9f3-4a61-8264-3fe912a3cb94-1-e8e8f792-7e31-4e8e-8d5f-85b88b335897.png" class="img-fluid"></p>
<section id="adding-an-input" class="level3">
<h3 class="anchored" data-anchor-id="adding-an-input">Adding an input</h3>
<div id="f787c906-5349-4dfe-81cc-57a351ed6903" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> command(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python hello_world_core.py --name $</span><span class="sc">{{</span><span class="st">inputs.name</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Hello World witn Input"</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>hello_world_component <span class="op">=</span> ml_client.create_or_update(job.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading hello_world (8.59 MBs): 100%|██████████| 8589758/8589758 [00:00&lt;00:00, 24178345.78it/s]

</code></pre>
</div>
</div>
<div id="dcf92501-5694-42f5-9515-cb4869609693" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the dsl decorator tells the sdk that we are defining an Azure Machine Learning pipeline</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> dsl</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world_pipeline(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input: <span class="bu">str</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Hello World pipeline</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_input: str</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Input to pipeline, here name of person to greed.</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    hello_world_job <span class="op">=</span> hello_world_component(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>pipeline_job_input,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8d2783f1-9ef3-45eb-be8b-a54f86c4a914" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> hello_world_pipeline(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input<span class="op">=</span><span class="st">"Joseph"</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    pipeline,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_hello_world_with_input"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: olive_plastic_gvnjy01b5s
Web View: https://ml.azure.com/runs/olive_plastic_gvnjy01b5s?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-26 14:38:43Z] Submitting 1 runs, first five are: cd1599c4:ce24c41e-946d-48cd-99b2-70ebde3befb2
[2024-03-26 14:44:58Z] Completing processing run id ce24c41e-946d-48cd-99b2-70ebde3befb2.

Execution Summary
=================
RunId: olive_plastic_gvnjy01b5s
Web View: https://ml.azure.com/runs/olive_plastic_gvnjy01b5s?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p>Notes about Input:</p>
<ul>
<li>When using Input(type=“uri_folder”) or Input(type=“uri_file”), the value passed cannot be a string, it must be an Input type, for example:</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> command(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        file_name<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> hello_world_pipeline(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input<span class="op">=</span>Input(path<span class="op">=</span><span class="st">"/path/to/file"</span>),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>However, when using Input(type=“string”) or Input(type=“number”), the input must be a string or number, not Input</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> command(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> hello_world_pipeline(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input<span class="op">=</span><span class="st">"Mary"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>In the latter case, the input does not appear in the graph of the pipeline, in the UI.</li>
</ul>
</section>
<section id="using-uri_file-as-input" class="level3">
<h3 class="anchored" data-anchor-id="using-uri_file-as-input">Using uri_file as input</h3>
<div id="ecaadb90-1e81-4d0a-b8fa-a401a190965a" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Component definition and registration</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> command(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python hello_world_core.py --name $</span><span class="sc">{{</span><span class="st">inputs.name</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"hello-world"</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Hello World with uri_file"</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>hello_world_component <span class="op">=</span> ml_client.create_or_update(job.component)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline definition and registration</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world_pipeline(</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input: <span class="bu">str</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Hello World pipeline</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Input to pipeline, here path to file.</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    hello_world_job <span class="op">=</span> hello_world_component(</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>pipeline_job_input,</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> hello_world_pipeline(</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    pipeline_job_input<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./hello_world_core.py"</span>),</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    pipeline,</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_hello_world_with_uri_file"</span>,</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading hello_world (8.59 MBs): 100%|██████████| 8588206/8588206 [00:00&lt;00:00, 24482901.98it/s]


Uploading hello_world_core.py (&lt; 1 MB): 0.00B [00:00, ?B/s] (&lt; 1 MB): 100%|██████████| 514/514 [00:00&lt;00:00, 12.0kB/s]

</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: great_tail_pw48pry0lj
Web View: https://ml.azure.com/runs/great_tail_pw48pry0lj?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-26 15:06:11Z] Submitting 1 runs, first five are: a08118c5:2099b6ad-fb3a-4cac-9557-c8cf355b8b1b
[2024-03-26 15:11:50Z] Completing processing run id 2099b6ad-fb3a-4cac-9557-c8cf355b8b1b.

Execution Summary
=================
RunId: great_tail_pw48pry0lj
Web View: https://ml.azure.com/runs/great_tail_pw48pry0lj?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p><img src="hello_world_files/figure-html/41f48859-e503-42d8-b66d-d9d504d39279-1-93ad73f7-be35-4f2e-a26c-0c85a6f32e4f.png" class="img-fluid"></p>
<ul>
<li>If you click on the “Data” component and inside it click on “Explore”, you can see the contents of the file, since it is a text python file.</li>
</ul>
</section>
<section id="adding-an-output" class="level3">
<h3 class="anchored" data-anchor-id="adding-an-output">Adding an output</h3>
<div id="bc85b398-20b4-4655-a3ed-79c43e66cb1d" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Component definition and registration</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> command(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python hello_world_core.py --name $</span><span class="sc">{{</span><span class="st">outputs.name</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Hello World with uri_file as output"</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>hello_world_component <span class="op">=</span> ml_client.create_or_update(job.component)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline definition and registration</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_world_pipeline(</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    hello_world_job <span class="op">=</span> hello_world_component()</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> hello_world_pipeline()</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    pipeline,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_hello_world_with_uri_file_as_output"</span>,</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading hello_world (9.48 MBs): 100%|██████████| 9483085/9483085 [00:00&lt;00:00, 22969826.09it/s]

</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: teal_soccer_m9bkcgz2gq
Web View: https://ml.azure.com/runs/teal_soccer_m9bkcgz2gq?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-26 15:36:23Z] Submitting 1 runs, first five are: 528b20ac:27e32a0a-71a0-4bc3-abec-eaeae70ff08e
[2024-03-26 15:41:30Z] Completing processing run id 27e32a0a-71a0-4bc3-abec-eaeae70ff08e.

Execution Summary
=================
RunId: teal_soccer_m9bkcgz2gq
Web View: https://ml.azure.com/runs/teal_soccer_m9bkcgz2gq?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
</section>
</section>
<section id="pipeline-with-two-components" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-with-two-components">Pipeline with two components</h2>
<p>In order to have something more meaningful, we create a pipeline with two components. The first one “pre-processes” the input data frame by adding one (or a specified number) to it, storing the output as a csv file. The second component builds a “model” by calculating the mean and standard deviation, and saves it as pickle file.</p>
<section id="make-subfolders-and-create-dummy-data" class="level3">
<h3 class="anchored" data-anchor-id="make-subfolders-and-create-dummy-data">Make subfolders and create dummy data</h3>
<p>Whenever we have multiple components, a common practice in Azure ML is to have a dedicated subfolder for each one. The subfolder contains the source .py file implementing the component, and may contain a conda yaml file with dependencies that are specific for this component. In our case, we use a pre-built environment so that we don’t need to include any conda yaml file.</p>
<div id="c58b92f4-3232-4f17-a3e0-eb44931cf3a3" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"preprocessing"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"training"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"data"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="41065e75-75f9-4f81-a2a7-5d2c5ece6b41" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame (</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"a"</span>: [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>],</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"b"</span>: [<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>],</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>df.to_csv (<span class="st">"data/dummy_input.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preprocessing-component" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-component">Preprocessing component</h3>
<div id="1eb04804-991f-4c25-89e7-bf4b4901813c" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile preprocessing<span class="op">/</span>preprocessing.py</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocessing (df, x):</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adds `x` to input data frame `df`."""</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"Adding </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> to df"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df <span class="op">+</span> x</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Output</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--input_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to input data frame"</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--preprocessed_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to output data frame"</span>)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"-x"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"number to add"</span>)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_preprocess (</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    input_data,</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    x,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    preprocessed_data,</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (input_data, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> preprocessing (df, x)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    df.to_csv (preprocessed_data)</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    read_and_preprocess (args.input_data, args.x, args.preprocessed_data)</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting preprocessing/preprocessing.py</code></pre>
</div>
</div>
<div id="24b74e38-eba1-4ab6-a5df-6faa3f55c19a" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Component definition and registration</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>preprocessing_command <span class="op">=</span> command(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python preprocessing.py --input_data $</span><span class="sc">{{</span><span class="st">inputs.input_data</span><span class="sc">}}</span><span class="st"> -x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> --preprocessed_data $</span><span class="sc">{{</span><span class="st">outputs.preprocessed_data</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> ml_client.create_or_update(preprocessing_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-component" class="level3">
<h3 class="anchored" data-anchor-id="training-component">Training component</h3>
<div id="6afcb989-5c77-4ed3-9d43-87dc83d51d00" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile training<span class="op">/</span>training.py</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model (df: pd.DataFrame):</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Trains a dummy Gaussian model from training set df."""</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> df.mean().values</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    std <span class="op">=</span> df.std().values</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"mu:</span><span class="ch">\n</span><span class="st">"</span>, mu)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"std:</span><span class="ch">\n</span><span class="st">"</span>, std)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mu, std</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--preprocessed_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to preprocessed data"</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--model"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to built model"</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_train (</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    preprocessed_data: <span class="bu">str</span>,</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    model_path: <span class="bu">str</span>,</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Reads training data, trains model, and saves it."""</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (preprocessed_data, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> train_model (df)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    joblib.dump (model, model_path)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    read_and_train (args.preprocessed_data, args.model)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting training/training.py</code></pre>
</div>
</div>
<div id="3b4f6fb0-26a4-471e-96c7-511673015eda" class="cell" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Component definition and registration</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>training_command <span class="op">=</span> command(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python training.py --preprocessed_data $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_data</span><span class="sc">}}</span><span class="st"> --model $</span><span class="sc">{{</span><span class="st">outputs.model</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>training_component <span class="op">=</span> ml_client.create_or_update(training_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading training (0.0 MBs): 100%|██████████| 1043/1043 [00:00&lt;00:00, 112778.01it/s]

</code></pre>
</div>
</div>
</section>
<section id="testing-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-pipeline">Testing the pipeline</h3>
<p>Before submitting the pipeline job, it is very important to test it first, ideally with some dummy or small dataset. For this purpose, in the component implementation above, we have separated the code related with argument parsing and the rest of the code, which is in encapsulated in a function called <code>read_and_&lt;...&gt;</code>. This way, we can easily write a test pipeline before implementing the final one, as follows:</p>
<div id="0e5f21b4-4479-4ee1-939c-d436fcce9e97" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will need to change the code as we iteratively refine it </span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># while testing the pipeline. For that purpose, we use the </span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># reload module</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span> </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessing <span class="im">import</span> preprocessing</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training <span class="im">import</span> training</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (preprocessing)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (training)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_pipeline (</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input: <span class="bu">str</span>,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x: <span class="bu">int</span>,</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    pipeline_job_preprocess_output: <span class="bu">str</span>,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    pipeline_job_model_output: <span class="bu">str</span>,</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Tests two component pipeline with preprocessing and training.</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data *file*</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_x: int</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to input data to convert it to "preprocessed" data.</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_test_input: str</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to (preprocessed) test input *file*</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_preprocess_output: str</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to preprocessed data *file*, to be used as training.</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in the final pipeline.</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_model_output: str</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to model *file*. Not present in the final pipeline.</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>    preprocessing.read_and_preprocess (</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>        pipeline_job_data_input,</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>        pipeline_job_x,</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>        pipeline_job_preprocess_output,</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    training.read_and_train (</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>        pipeline_job_preprocess_output,</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>        pipeline_job_model_output,</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"test_pipeline"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>test_pipeline (</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>,</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>    pipeline_job_preprocess_output<span class="op">=</span><span class="st">"./test_pipeline/preprocessed_data.csv"</span>,</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>    pipeline_job_model_output<span class="op">=</span><span class="st">"./test_pipeline/model.pk"</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input
    a  b
0  1  4
1  2  5
2  3  6
Adding 10 to df
Output
     a   b
0  11  14
1  12  15
2  13  16
Input
     a   b
0  11  14
1  12  15
2  13  16
mu:
 [12. 15.]
std:
 [1. 1.]</code></pre>
</div>
</div>
</section>
<section id="pipeline" class="level3">
<h3 class="anchored" data-anchor-id="pipeline">Pipeline</h3>
<p>Now we are ready to implement and submit our pipeline. The code will be very similar to the <code>test_pipeline</code> implemented above, except for the fact that we don’t need to indicate the outputs that connect one component to the next, since these are automatically populated by AML.</p>
<div id="55196b04-892c-4e33-8c17-2ccf40fcdaf6" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline definition and registration</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> two_components_pipeline(</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input: <span class="bu">str</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x: <span class="bu">int</span>,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Pipeline with two components: preprocessing, and training.</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data *file*</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_x: int</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to input data to convert it to "preprocessed" data.</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    preprocessing_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>pipeline_job_data_input,</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>pipeline_job_x,</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using train_func like a python call with its own inputs</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>preprocessing_job.outputs.preprocessed_data,  <span class="co"># note: using outputs from previous step</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>two_components_pipeline <span class="op">=</span> two_components_pipeline(</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>),</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>two_components_pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    two_components_pipeline,</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_two_components_pipeline"</span>,</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(two_components_pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: quiet_root_nb0c997gsp
Web View: https://ml.azure.com/runs/quiet_root_nb0c997gsp?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-27 10:45:01Z] Submitting 1 runs, first five are: caf1c51e:87b5910c-0e8d-4ca0-a808-f52a94d52b56
[2024-03-27 10:51:05Z] Completing processing run id 87b5910c-0e8d-4ca0-a808-f52a94d52b56.
[2024-03-27 10:51:05Z] Submitting 1 runs, first five are: 3d73a420:6c033636-f3d8-4fe2-ba8d-26072210ba05
[2024-03-27 10:56:25Z] Completing processing run id 6c033636-f3d8-4fe2-ba8d-26072210ba05.

Execution Summary
=================
RunId: quiet_root_nb0c997gsp
Web View: https://ml.azure.com/runs/quiet_root_nb0c997gsp?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p>We can see the created pipeline in the Pipelines section of our workspace:</p>
<p><img src="hello_world_files/figure-html/6598eeb2-ec85-4cf3-a55b-907b8da371a2-1-24429e4f-68f1-4573-8f7c-d01ae06225f8.png" class="img-fluid"></p>
<p><img src="hello_world_files/figure-html/1092d234-5164-4402-a91f-dafde8638c05-1-01db64fa-bfde-47fb-983c-99904209c947.png" class="img-fluid"></p>
<p><img src="hello_world_files/figure-html/a71ea0ca-a7fe-4ffb-b2e4-ca357fbed3ff-1-0cfdd7b6-3678-449d-9c6d-03d0e49e2a72.png" class="img-fluid"></p>
<p><img src="hello_world_files/figure-html/81edbda0-fe56-4ea0-865e-aeadfe70429d-1-8f86b764-f75d-45d6-9a45-abe9400202f1.png" class="img-fluid"></p>
<p><img src="hello_world_files/figure-html/60bd9d47-1920-4ae7-859e-6d860d9d3ba0-1-9fdab714-d9d0-41d2-ae55-a7a5996f64ef.png" class="img-fluid"></p>
<p>We can see that:</p>
<ol type="1">
<li>The path to the preprocessed data has been automatically set to <code>azureml/49824a8b-967f-4410-84a7-bc18b328a1b6/preprocessed_data</code>, where the file name <code>preprocessed_data</code> is the name of the output given in the component definition:</li>
</ol>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Since this file name doesn’t have an extension, we cannot preview (see arrow 2). However, we can see its contents if we view the file in the datastore, as indicated below:</li>
</ol>
<p><img src="hello_world_files/figure-html/6688eaad-83bf-4ab4-8c5b-a1eb31d4aaef-1-7976a554-9c77-4302-8fb6-42523f09a94b.png" class="img-fluid"></p>
<p>Unfortunately, the content of the file appears in text format, rather than as a table.</p>
<p><img src="hello_world_files/figure-html/c18cd10b-5e48-44ba-8fee-cbe97dd8ecaf-1-8be561ed-ab27-4c5a-8b8b-a354ab63508c.png" class="img-fluid"></p>
<p>We can also see the content of the outputs by inspecting the logs of the training component:</p>
<p><img src="hello_world_files/figure-html/1125bfe2-6583-49ff-af20-294fa716bab9-1-cb4e2d8f-db31-44ba-963c-08196c449847.png" class="img-fluid"></p>
</section>
</section>
<section id="using-uri_folder" class="level2">
<h2 class="anchored" data-anchor-id="using-uri_folder">Using uri_folder</h2>
<section id="main-differences" class="level3">
<h3 class="anchored" data-anchor-id="main-differences">Main differences</h3>
<p>Let’s try now using outputs of type “uri_folder”. We need to do two changes for this purpose:</p>
<ol type="1">
<li>In the component modules, preprocessing/preprocessing.py and training/training.py, the output arguments <code>args.preprocessed_data</code> and <code>args.model</code> will contain a path to a folder where the file is stored. Therefore, when saving the file, we need to append its name to the input path:</li>
</ol>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#In preprocessing module:</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>df.to_csv (preprocessed_data <span class="op">+</span> <span class="st">"/preprocessed_data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In training module:</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv (preprocessed_data <span class="op">+</span> <span class="st">"/preprocessed_data.csv"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># later in same module:</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>joblib.dump (model, model_path <span class="op">+</span> <span class="st">"/model.pk"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>In the definition of the pipeline, we replace the type of the outputs to be “uri_folder”, and the input to the training component to be “uri_folder” as well.</li>
</ol>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In preprocessing component</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    ...    </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In training component</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here we have the final implementation of our components:</p>
</section>
<section id="preprocessing-component-1" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-component-1">Preprocessing component</h3>
<div id="ac665b85-f9fb-47bc-aaa3-e448c76de952" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile preprocessing<span class="op">/</span>preprocessing.py</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocessing (df, x):</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adds `x` to input data frame `df`."""</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"Adding </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> to df"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df <span class="op">+</span> x</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Output</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--input_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to input data *file*"</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--preprocessed_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to output data *folder* containing the preprocessed data."</span>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"-x"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"number to add"</span>)</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_preprocess (</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    input_data,</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    x,</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    preprocessed_data,</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (input_data, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> preprocessing (df, x)</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    df.to_csv (preprocessed_data <span class="op">+</span> <span class="st">"/preprocessed_data.csv"</span>)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    read_and_preprocess (args.input_data, args.x, args.preprocessed_data)</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting preprocessing/preprocessing.py</code></pre>
</div>
</div>
<div id="1324f1c3-5aee-4243-806f-785c17f7e0a5" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>preprocessing_command <span class="op">=</span> command(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python preprocessing.py --input_data $</span><span class="sc">{{</span><span class="st">inputs.input_data</span><span class="sc">}}</span><span class="st"> -x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> --preprocessed_data $</span><span class="sc">{{</span><span class="st">outputs.preprocessed_data</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> ml_client.create_or_update(preprocessing_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-component-1" class="level3">
<h3 class="anchored" data-anchor-id="training-component-1">Training component</h3>
<div id="fa33ef2c-964f-4ccd-a19d-e6a3c9d06e61" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile training<span class="op">/</span>training.py</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model (df: pd.DataFrame):</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Trains a dummy Gaussian model from training set df."""</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> df.mean().values</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    std <span class="op">=</span> df.std().values</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"mu:</span><span class="ch">\n</span><span class="st">"</span>, mu)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"std:</span><span class="ch">\n</span><span class="st">"</span>, std)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mu, std</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--preprocessed_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to preprocessed data"</span>)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--model"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to built model"</span>)</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_train (</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    preprocessed_data: <span class="bu">str</span>,</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    model_path: <span class="bu">str</span>,</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Reads training data, trains model, and saves it."""</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (preprocessed_data <span class="op">+</span> <span class="st">"/preprocessed_data.csv"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> train_model (df)</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>    joblib.dump (model, model_path <span class="op">+</span> <span class="st">"/model.pk"</span>)</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    read_and_train (args.preprocessed_data, args.model)</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting training/training.py</code></pre>
</div>
</div>
<div id="afb383f6-84b7-469b-a2e6-b8b640d56209" class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Component definition and registration</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>training_command <span class="op">=</span> command(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python training.py --preprocessed_data $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_data</span><span class="sc">}}</span><span class="st"> --model $</span><span class="sc">{{</span><span class="st">outputs.model</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>training_component <span class="op">=</span> ml_client.create_or_update(training_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading training (0.0 MBs): 100%|██████████| 1084/1084 [00:00&lt;00:00, 39997.06it/s]

</code></pre>
</div>
</div>
</section>
<section id="testing-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-pipeline-1">Testing the pipeline</h3>
<p>Again, before submitting the pipeline job, we first test a manually built pipeline. Note that the new pipeline uses paths to folders, and not paths to files, for the outputs:</p>
<div id="a83060e5-7abe-43e3-823a-97d6089feef2" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessing <span class="im">import</span> preprocessing</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training <span class="im">import</span> training</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (preprocessing)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (training)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_pipeline (</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input: <span class="bu">str</span>,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x: <span class="bu">int</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    pipeline_job_preprocess_output: <span class="bu">str</span>,</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    pipeline_job_model_output: <span class="bu">str</span>,</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Tests two component pipeline with preprocessing and training.</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data *file*</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_x: int</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to input data to convert it to "preprocessed" data.</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_test_input: str</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to (preprocessed) test input *file*</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_preprocess_output: str</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to preprocessed data *folder*, to be used as training.</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in the final pipeline.</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_model_output: str</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to model *folder*. Not present in the final pipeline.</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    preprocessing.read_and_preprocess (</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        pipeline_job_data_input,</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        pipeline_job_x,</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>        pipeline_job_preprocess_output,</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>    training.read_and_train (</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>        pipeline_job_preprocess_output,</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>        pipeline_job_model_output,</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"test_pipeline"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>test_pipeline (</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>,</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>    pipeline_job_preprocess_output<span class="op">=</span><span class="st">"./test_pipeline"</span>,</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>    pipeline_job_model_output<span class="op">=</span><span class="st">"./test_pipeline"</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input
    a  b
0  1  4
1  2  5
2  3  6
Adding 10 to df
Output
     a   b
0  11  14
1  12  15
2  13  16
Input
     a   b
0  11  14
1  12  15
2  13  16
mu:
 [12. 15.]
std:
 [1. 1.]</code></pre>
</div>
</div>
<p>… and the implementation of our pipeline:</p>
</section>
<section id="pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-1">Pipeline</h3>
<div id="5fc00f30-7d03-467d-ba17-12fa77af433c" class="cell" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> two_components_pipeline(</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Pipeline with two components: preprocessing, and training.</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data *file*</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_x: int</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to input data to convert it to "preprocessed" data.</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    preprocessing_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>pipeline_job_data_input,</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>pipeline_job_x,</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using train_func like a python call with its own inputs</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>preprocessing_job.outputs.preprocessed_data,  <span class="co"># note: using outputs from previous step</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>two_components_pipeline <span class="op">=</span> two_components_pipeline(</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>),</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>two_components_pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>    two_components_pipeline,</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_two_components_pipeline_with_uri_folder"</span>,</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(two_components_pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: calm_zebra_t3gb5cjnrk
Web View: https://ml.azure.com/runs/calm_zebra_t3gb5cjnrk?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-28 08:45:53Z] Completing processing run id 1ff53a74-943f-4f94-8efd-4b55b345449f.
[2024-03-28 08:45:54Z] Submitting 1 runs, first five are: e26d0be6:8e0f40eb-e2c3-4feb-a0d0-9882de1daebc

Execution Summary
=================
RunId: calm_zebra_t3gb5cjnrk
Web View: https://ml.azure.com/runs/calm_zebra_t3gb5cjnrk?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p>Now, when we go to the “Explore” tab, in the output data of the preprocessed component, we can see the contents of the output preprocessed data in tabular format. We can also see that the extension of the output, which is csv file:</p>
<p><img src="hello_world_files/figure-html/73086335-44b6-4aad-b624-3ea8d454a543-1-8de4c649-c9ae-4ee4-81b6-16226923eb51.png" class="img-fluid"></p>
</section>
</section>
<section id="pipeline-with-three-components" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-with-three-components">Pipeline with three components</h2>
<p>We add now a third component, which takes as input test data, preprocesses it, and uses the model to perform “inference”. For this pipeline, we can reuse the training component from the last section, but we need to slighty modify the preprocessing component to use an additional argument: the name of the output file. This is needed because there will be two outputs: one when preprocessing the training data, and the other when preprocessing the test data.</p>
<section id="preparing-data" class="level3">
<h3 class="anchored" data-anchor-id="preparing-data">Preparing data</h3>
<div id="98c896b8-4f5e-4949-bcf8-041c5bac1e13" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"inference"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> pd.DataFrame (</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"a"</span>: [<span class="fl">11.</span>, <span class="fl">12.1</span>, <span class="fl">13.1</span>],</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"b"</span>: [<span class="fl">14.1</span>, <span class="fl">15.1</span>, <span class="fl">16.1</span>],</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>test_data.to_csv (<span class="st">"data/dummy_test.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preprocessing-component-2" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-component-2">Preprocessing component</h3>
<div id="601b94b4-e17b-43d6-a97b-b5d138b73012" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile preprocessing<span class="op">/</span>preprocessing.py</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocessing (df, x):</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adds `x` to input data frame `df`."""</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"Adding </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> to df"</span>)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df <span class="op">+</span> x</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Output</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--input_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to input data *file*"</span>)</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--preprocessed_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to output data *folder* containing the preprocessed data."</span>)</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--preprocessed_file_name"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"name of preprocessed file name."</span>)</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"-x"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"number to add"</span>)</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_preprocess (</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    input_data: <span class="bu">str</span>,</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>    preprocessed_data: <span class="bu">str</span>,</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>    preprocessed_file_name: <span class="bu">str</span>,</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (input_data, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> preprocessing (df, x)</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>    df.to_csv (<span class="ss">f"</span><span class="sc">{</span>preprocessed_data<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>preprocessed_file_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>    read_and_preprocess (</span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>args.input_data, </span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>args.preprocessed_data,</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>        preprocessed_file_name<span class="op">=</span>args.preprocessed_file_name,</span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>args.x, </span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting preprocessing/preprocessing.py</code></pre>
</div>
</div>
<div id="61f5f219-f083-4787-b8ed-45f168dd160d" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>preprocessing_command <span class="op">=</span> command(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        preprocessed_file_name<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python preprocessing.py --input_data $</span><span class="sc">{{</span><span class="st">inputs.input_data</span><span class="sc">}}</span><span class="st"> -x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> --preprocessed_data $</span><span class="sc">{{</span><span class="st">outputs.preprocessed_data</span><span class="sc">}}</span><span class="st"> --preprocessed_file_name $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_file_name</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> ml_client.create_or_update(preprocessing_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading preprocessing (0.0 MBs): 100%|██████████| 1343/1343 [00:00&lt;00:00, 46879.53it/s]

</code></pre>
</div>
</div>
<p>The preprocessing component doesn’t change from the last pipeline, see “Using uri_folder” section.</p>
</section>
<section id="inference-component" class="level3">
<h3 class="anchored" data-anchor-id="inference-component">Inference component</h3>
<div id="3a3fb08e-6990-4ec4-a79a-4cffeeaa6bd8" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile inference<span class="op">/</span>inference.py</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inference (</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    model: Tuple[np.ndarray, np.ndarray], </span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Runs dummy inference on new data `df`</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    (mu, std) <span class="op">=</span> model</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    z_df <span class="op">=</span> (df <span class="op">-</span> mu) <span class="op">/</span> std</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Inference result:"</span>)</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (z_df)</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> z_df</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--test_data"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to test data *folder*"</span>)</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--test_data_file_name"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"name of test data file name."</span>)</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--model"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to built model *folder*"</span>)</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--inference_output"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to inference result *folder*"</span>)</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_inference (</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>    test_data: <span class="bu">str</span>,</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>    test_data_file_name: <span class="bu">str</span>,</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>    model_path: <span class="bu">str</span>,</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>    inference_data: <span class="bu">str</span>,</span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Reads test data and model, performs inference, and writes to output inference file.</span></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a><span class="co">    test_data: str</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to test (preprocessed) data *folder*</span></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a><span class="co">    test_data_file_name: str</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of test data file.</span></span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="co">    model_path: str</span></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to built model *folder*</span></span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_data: str</span></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to inference result *folder*</span></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (<span class="ss">f"</span><span class="sc">{</span>test_data<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>test_data_file_name<span class="sc">}</span><span class="ss">"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> joblib.load (model_path <span class="op">+</span> <span class="st">"/model.pk"</span>)</span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>    z_df <span class="op">=</span> inference (model, df)</span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>    z_df.to_csv (inference_data <span class="op">+</span> <span class="st">"/inference_result.csv"</span>)</span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>    read_and_inference (</span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a>        test_data<span class="op">=</span>args.test_data, </span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a>        test_data_file_name<span class="op">=</span>args.test_data_file_name,</span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a>        model_path<span class="op">=</span>args.model, </span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a>        inference_data<span class="op">=</span>args.inference_output,</span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting inference/inference.py</code></pre>
</div>
</div>
<div id="579b53aa-15e0-47cb-a304-c389ece977ed" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>inference_command <span class="op">=</span> command(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>        test_data<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>        test_data_file_name<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        inference_output<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./inference/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python inference.py "</span> </span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--test_data $</span><span class="sc">{{</span><span class="st">inputs.test_data</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--test_data_file_name $</span><span class="sc">{{</span><span class="st">inputs.test_data_file_name</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--model $</span><span class="sc">{{</span><span class="st">inputs.model</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--inference_output $</span><span class="sc">{{</span><span class="st">outputs.inference_output</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"inference"</span>,</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>inference_component <span class="op">=</span> ml_client.create_or_update(inference_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading inference (0.0 MBs): 100%|██████████| 1912/1912 [00:00&lt;00:00, 63810.98it/s]

</code></pre>
</div>
</div>
</section>
<section id="testing-the-pipeline-2" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-pipeline-2">Testing the pipeline</h3>
<p>Before submitting the pipeline job, it is very important to test it first, ideally with some dummy or small dataset. For this purpose, in the component implementation above, we have separated the code related with argument parsing and the rest of the code, which is in encapsulated in a function called <code>read_and_&lt;...&gt;</code>. This way, we can easily write a test pipeline before implementing the final one, as follows:</p>
<div id="5fa88be4-58bc-4247-8d58-6640f8466e62" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will need to change the code as we iteratively refine it </span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># while testing the pipeline. For that purpose, we use the </span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># reload module</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span> </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessing <span class="im">import</span> preprocessing</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training <span class="im">import</span> training</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> inference <span class="im">import</span> inference</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (preprocessing)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (training)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (inference)</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_pipeline (</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input: <span class="bu">str</span>,</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x: <span class="bu">int</span>,</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    pipeline_job_test_input: <span class="bu">str</span>,</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    pipeline_preprocessed_file_name: <span class="bu">str</span>,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    pipeline_test_file_name: <span class="bu">str</span>,</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The following parameters are not present in the final pipeline:</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>    pipeline_job_preprocess_output: <span class="bu">str</span>,</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    pipeline_job_test_output: <span class="bu">str</span>,</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    pipeline_job_model_output: <span class="bu">str</span>,</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    pipeline_job_inference_output: <span class="bu">str</span>,</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Tests third pipeline: preprocessing, training and inference.</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data *file*</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_x: int</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to input data to convert it to "preprocessed" data.</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_test_input: str</span></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to (preprocessed) test input *file*</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_test_input: str</span></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to (preprocessed) test input *file*</span></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_preprocessed_file_name: str</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of (preprocessed) input data file.</span></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_test_file_name: str</span></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of (preprocessed) test data file.</span></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_preprocess_output: str</span></span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to preprocessed data *folder*, to be used as training.</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in the final pipeline.</span></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_test_output: str</span></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to preprocessed test data *folder*, to be used for inferencing.</span></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in the final pipeline.</span></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_model_output: str</span></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to model *folder*. Not present in the final pipeline.</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_inference_output: str</span></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to inference result *folder*. Not present in the final pipeline.</span></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>    preprocessing.read_and_preprocess (</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>        pipeline_job_data_input,</span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>        pipeline_job_preprocess_output,</span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>        pipeline_preprocessed_file_name,</span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>        pipeline_job_x,</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>    preprocessing.read_and_preprocess (</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>        pipeline_job_test_input,</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>        pipeline_job_test_output,</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>        pipeline_test_file_name,</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>        pipeline_job_x,</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a>    training.read_and_train (</span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a>        pipeline_job_preprocess_output,</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a>        pipeline_job_model_output,</span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a>    inference.read_and_inference (</span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>        test_data<span class="op">=</span>pipeline_job_test_output,</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a>        test_data_file_name<span class="op">=</span>pipeline_test_file_name,</span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a>        model_path<span class="op">=</span>pipeline_job_model_output,</span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>        inference_data<span class="op">=</span>pipeline_job_inference_output,</span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"test_pipeline"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a>test_pipeline (</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>,</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a>    pipeline_job_test_input<span class="op">=</span><span class="st">"./data/dummy_test.csv"</span>,</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>    pipeline_preprocessed_file_name<span class="op">=</span><span class="st">"preprocessed_data.csv"</span>,</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>    pipeline_test_file_name<span class="op">=</span><span class="st">"preprocessed_test.csv"</span>,</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The following parameters are not present in the final pipeline:</span></span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a>    pipeline_job_preprocess_output<span class="op">=</span><span class="st">"./test_pipeline"</span>,</span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>    pipeline_job_test_output<span class="op">=</span><span class="st">"./test_pipeline"</span>,</span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a>    pipeline_job_model_output<span class="op">=</span><span class="st">"./test_pipeline"</span>,</span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a>    pipeline_job_inference_output<span class="op">=</span><span class="st">"./test_pipeline"</span>,</span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input
    a  b
0  1  4
1  2  5
2  3  6
Adding 10 to df
Output
     a   b
0  11  14
1  12  15
2  13  16
Input
       a     b
0  11.0  14.1
1  12.1  15.1
2  13.1  16.1
Adding 10 to df
Output
       a     b
0  21.0  24.1
1  22.1  25.1
2  23.1  26.1
Input
     a   b
0  11  14
1  12  15
2  13  16
mu:
 [12. 15.]
std:
 [1. 1.]
Inference result:
      a     b
0   9.0   9.1
1  10.1  10.1
2  11.1  11.1</code></pre>
</div>
</div>
</section>
<section id="pipeline-2" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-2">Pipeline</h3>
<div id="d477c5a1-48bb-4b54-ae81-a495edf87c0a" class="cell" data-tags="[]" data-execution_count="53">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> three_components_pipeline(</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input: <span class="bu">str</span>,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x: <span class="bu">int</span>,</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    pipeline_job_test_input: <span class="bu">str</span>,</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    pipeline_preprocessed_file_name: <span class="bu">str</span>,</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    pipeline_test_file_name: <span class="bu">str</span>,</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Third pipeline: preprocessing, training and inference.</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_data_input: str</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data *file*</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_x: int</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to input data to convert it to "preprocessed" data.</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_job_test_input: str</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to (preprocessed) test input *file*</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_preprocessed_file_name: str</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of (preprocessed) input data file.</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a><span class="co">    pipeline_test_file_name: str</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of (preprocessed) test data file.</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    preprocessing_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>pipeline_job_data_input,</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>pipeline_job_x,</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>        preprocessed_file_name<span class="op">=</span>pipeline_preprocessed_file_name,</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>pipeline_job_test_input,</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>pipeline_job_x,</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>        preprocessed_file_name<span class="op">=</span>pipeline_test_file_name,</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using train_func like a python call with its own inputs</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>        preprocessed_data<span class="op">=</span>preprocessing_job.outputs.preprocessed_data,  <span class="co"># note: using outputs from previous step</span></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using train_func like a python call with its own inputs</span></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>    inference_job <span class="op">=</span> inference_component(</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>        test_data<span class="op">=</span>preprocessing_test_job.outputs.preprocessed_data,</span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>        test_data_file_name<span class="op">=</span>pipeline_test_file_name,</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>training_job.outputs.model,  <span class="co"># note: using outputs from previous step</span></span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>three_components_pipeline <span class="op">=</span> three_components_pipeline(</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    pipeline_job_data_input<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>),</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>    pipeline_job_x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>    pipeline_job_test_input<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./data/dummy_test.csv"</span>),</span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>    pipeline_preprocessed_file_name<span class="op">=</span><span class="st">"preprocessed_data.csv"</span>,</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>    pipeline_test_file_name<span class="op">=</span><span class="st">"preprocessed_test_data.csv"</span>,</span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>three_components_pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline,</span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_three_components_pipeline_with_uri_folder"</span>,</span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(three_components_pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: calm_rice_3cmmmtc5mf
Web View: https://ml.azure.com/runs/calm_rice_3cmmmtc5mf?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-28 10:15:12Z] Submitting 2 runs, first five are: 47ca85c2:a5595dea-3117-47e9-a99d-186b0c346884,4b1f0180:09aecbcc-aa2c-4cad-b134-eb4837724f58
[2024-03-28 10:20:13Z] Completing processing run id 09aecbcc-aa2c-4cad-b134-eb4837724f58.
[2024-03-28 10:20:13Z] Submitting 1 runs, first five are: fece868d:164d1e2a-a5d7-4081-9a68-a07033a3feee
[2024-03-28 10:20:45Z] Completing processing run id 164d1e2a-a5d7-4081-9a68-a07033a3feee.
[2024-03-28 10:22:15Z] Completing processing run id a5595dea-3117-47e9-a99d-186b0c346884.
[2024-03-28 10:22:16Z] Submitting 1 runs, first five are: a9d60b27:6a18ae74-2a3c-4e16-a6cb-a58649235bfe
[2024-03-28 10:22:52Z] Completing processing run id 6a18ae74-2a3c-4e16-a6cb-a58649235bfe.

Execution Summary
=================
RunId: calm_rice_3cmmmtc5mf
Web View: https://ml.azure.com/runs/calm_rice_3cmmmtc5mf?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p>Here we can see the resulting pipeline:</p>
<p><img src="hello_world_files/figure-html/acb8b9b3-e2b5-49f0-90c3-1eeb33aa29dc-1-5e09eb0f-240d-4b9c-95d8-3b46c4047fbe.png" class="img-fluid"></p>
</section>
</section>
<section id="refactoring" class="level2">
<h2 class="anchored" data-anchor-id="refactoring">Refactoring</h2>
<section id="style-guide" class="level3">
<h3 class="anchored" data-anchor-id="style-guide">Style guide</h3>
<p>From the development of the different pipelines we can extract a few observations that help us create a better refactored pipeline and, at the same time, compile a small set of “design” rules that may help us in future pipelines. In my case, I find it clearer and with less boilerplate to use the following rules:</p>
<ul>
<li>Use “uri_folder” type for intermediate outputs, and add another parameter next to it containing the output file, something like:</li>
</ul>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pipeline(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    input_folder: <span class="bu">str</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    input_filename: <span class="bu">str</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Use “_folder” as a prefix for parameters of type <code>uri_folder</code>, “_file” for those of type <code>uri_file</code>, and “_filename” for those indicating names of file names.</p></li>
<li><p>Use the suffix <code>input</code> for those things that are inputs and <code>ouput</code>for those that are outputs.</p></li>
<li><p>I’m not clear about this one. Many people usually pass a dataframe called <code>df</code> or a numpy array called <code>X</code>, which is passed from one step of the pipeline to the next, without appending words to the name that talk about the content of the dataframe or the array (e.g., use “X” instead of “preprocessed_X” or “inference_result_X”). I tend to find it easier to do a similar thing here for the <em>inputs</em> of intermediate components, when defining the <code>command</code> for those components. Therefore, <em>for the inputs</em>, I would use <code>input_folder</code> rather than <code>preprocessed_training_data_input_folder</code> for indicating the input to the model component. This means that if we replace later the model component with one that works directly on raw (non-preprocessed) data (e.g., because the preprocessing is implicitly done as part of the model), we don’t need to replace the part of the script that parses the arguments to indicate that now the input folder is just <code>training_data_input_folder</code>.</p></li>
<li><p>For the outputs, it might be useful to add a short prefix to talk about the type of output, so that the pipeline’s diagram shows what is the ouput of each component is. Again, I’m not clear about this one.</p></li>
<li><p>The exception to the previous rules is when we have more than one input or output folder. In this case, we clearly need to add more words to their names.</p></li>
<li><p>It is easier to avoid adding <code>pipeline_job_...</code> for each parameter of the pipeline.</p></li>
</ul>
</section>
</section>
<section id="final-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="final-pipeline">Final pipeline</h2>
<section id="preprocessing-component-3" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-component-3">Preprocessing component</h3>
<div id="69e6142a" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile preprocessing<span class="op">/</span>preprocessing.py</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocessing (</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adds `x` to input data frame `df`.</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co">    df: DataFrame</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Input data frame </span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Integer to add to df.</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame.</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Preprocessed data.</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="ss">f"Adding </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss"> to df"</span>)</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df <span class="op">+</span> x</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Output</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--input_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to input data file"</span>)</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--output_folder"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"path to output data folder containing the preprocessed data."</span>)</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"--output_filename"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"name of file containing the output, preprocessed, data."</span>)</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"-x"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"number to add to input data for preprocessing it."</span>)</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_preprocess (</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>    input_file: <span class="bu">str</span>,</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    output_folder: <span class="bu">str</span>,</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    output_filename: <span class="bu">str</span>,</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Reads input data, preprocesses it, and writes result as csv file in disk.</span></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a><span class="co">    input_file: str</span></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to input data file.</span></span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a><span class="co">    output_folder: str</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to output data folder containing the preprocessed data.</span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a><span class="co">    output_filename: str</span></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output, preprocessed, data.</span></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Number to add to input data for preprocessing it.</span></span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (input_file, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> preprocessing (df, x)</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>    df.to_csv (<span class="ss">f"</span><span class="sc">{</span>output_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>output_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>    read_and_preprocess (</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>args.input_file, </span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>args.output_folder,</span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>args.output_filename,</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>args.x, </span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting preprocessing/preprocessing.py</code></pre>
</div>
</div>
<div id="a1dee56e" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>preprocessing_command <span class="op">=</span> command(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python preprocessing.py "</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_file $</span><span class="sc">{{</span><span class="st">inputs.input_file</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> ml_client.create_or_update(preprocessing_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading preprocessing (0.0 MBs): 100%|██████████| 1985/1985 [00:00&lt;00:00, 64070.90it/s]

</code></pre>
</div>
</div>
</section>
<section id="training-component-2" class="level3">
<h3 class="anchored" data-anchor-id="training-component-2">Training component</h3>
<div id="b1624eb1" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile training<span class="op">/</span>training.py</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model (df: pd.DataFrame):</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Trains a dummy Gaussian model from training set df.</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">    df: DataFrame</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Input data frame</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a><span class="co">    np.ndarray</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Average across rows, one per column.</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="co">    np.ndarray</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Standard deviation across rows, one per column.</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Input</span><span class="ch">\n</span><span class="st">"</span>, df)</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> df.mean().values</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    std <span class="op">=</span> df.std().values</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"mu:</span><span class="ch">\n</span><span class="st">"</span>, mu)</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"std:</span><span class="ch">\n</span><span class="st">"</span>, std)</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mu, std</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_folder"</span>, </span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"path to preprocessed training data folder, "</span></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>             <span class="st">"containing training set file."</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_filename"</span>, </span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"name of file containing preprocessed, training data."</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder"</span>, </span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"path to output *folder* containing the trained model."</span></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename"</span>, </span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"name of file containing the trained model."</span></span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_train (</span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a>    input_folder: <span class="bu">str</span>,</span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>    input_filename: <span class="bu">str</span>,</span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>    output_folder: <span class="bu">str</span>,</span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a>    output_filename: <span class="bu">str</span>,</span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Reads training data, trains model, and saves it.</span></span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a><span class="co">    input_folder: str</span></span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to preprocessed training data folder containing training set file.</span></span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a><span class="co">    input_filename: str</span></span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing preprocessed, training data.</span></span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a><span class="co">    output_folder: str</span></span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to output folder containing the trained model.</span></span>
<span id="cb84-75"><a href="#cb84-75" aria-hidden="true" tabindex="-1"></a><span class="co">    output_filename: str</span></span>
<span id="cb84-76"><a href="#cb84-76" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the trained model.</span></span>
<span id="cb84-77"><a href="#cb84-77" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb84-78"><a href="#cb84-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-79"><a href="#cb84-79" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (<span class="ss">f"</span><span class="sc">{</span>input_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>input_filename<span class="sc">}</span><span class="ss">"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb84-80"><a href="#cb84-80" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> train_model (df)</span>
<span id="cb84-81"><a href="#cb84-81" aria-hidden="true" tabindex="-1"></a>    joblib.dump (model, <span class="ss">f"</span><span class="sc">{</span>output_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>output_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb84-82"><a href="#cb84-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-83"><a href="#cb84-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb84-84"><a href="#cb84-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb84-85"><a href="#cb84-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-86"><a href="#cb84-86" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb84-87"><a href="#cb84-87" aria-hidden="true" tabindex="-1"></a>    read_and_train (</span>
<span id="cb84-88"><a href="#cb84-88" aria-hidden="true" tabindex="-1"></a>        args.input_folder, </span>
<span id="cb84-89"><a href="#cb84-89" aria-hidden="true" tabindex="-1"></a>        args.input_filename,</span>
<span id="cb84-90"><a href="#cb84-90" aria-hidden="true" tabindex="-1"></a>        args.output_folder,</span>
<span id="cb84-91"><a href="#cb84-91" aria-hidden="true" tabindex="-1"></a>        args.output_filename,</span>
<span id="cb84-92"><a href="#cb84-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-93"><a href="#cb84-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-94"><a href="#cb84-94" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb84-95"><a href="#cb84-95" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting training/training.py</code></pre>
</div>
</div>
<div id="49fe65c9" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Component definition and registration</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>training_command <span class="op">=</span> command(</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python training.py "</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_folder $</span><span class="sc">{{</span><span class="st">inputs.input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_filename $</span><span class="sc">{{</span><span class="st">inputs.input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>training_component <span class="op">=</span> ml_client.create_or_update(training_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading training (0.0 MBs): 100%|██████████| 2309/2309 [00:00&lt;00:00, 50917.16it/s]

</code></pre>
</div>
</div>
</section>
<section id="inference-component-1" class="level3">
<h3 class="anchored" data-anchor-id="inference-component-1">Inference component</h3>
<div id="50fa331d" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile inference<span class="op">/</span>inference.py</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> DistanceMetric</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inference (</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    model: Tuple[np.ndarray, np.ndarray], </span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame,</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Runs dummy inference on new data `df`.</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="co">    model: Tople (np.ndarray, np.ndarray)</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Average across rows (one per column), and </span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="co">        standard deviation across rows (one per column).</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a><span class="co">    df: DataFrame</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Test data frame on which to perform inference.</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame</span></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a><span class="co">        One column dataframe giving an approximation of the Mahalanobis distance </span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a><span class="co">        between each row vector and the mean vector, assuming that the covariance </span></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a><span class="co">        matrix is diagonal. The negative of the scores obtained can be considered </span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a><span class="co">        as a sort of prediction probability for each row of belonging to the Gaussian </span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a><span class="co">        class estimated from the training data. In this sense this function provides</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a><span class="co">        inference about how "normal" the test samples are. </span></span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>    (mu, std) <span class="op">=</span> model</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> DistanceMetric.get_metric(<span class="st">'mahalanobis'</span>, V<span class="op">=</span>np.diag(std<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>    ndims <span class="op">=</span> df.shape[<span class="dv">1</span>]</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>    mah_dist <span class="op">=</span> dist.pairwise (mu.reshape(<span class="dv">1</span>, ndims), df)</span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>    mah_dist <span class="op">=</span> pd.DataFrame (mah_dist.ravel(), columns<span class="op">=</span>[<span class="st">"distance"</span>])</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Inference result:"</span>)</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (mah_dist)</span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mah_dist</span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--preprocessed_input_folder"</span>, </span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"path to input, preprocessed, test data folder, "</span></span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>             <span class="st">"containing file on which to perform inference."</span></span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--preprocessed_input_filename"</span>, </span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"name of file containing the input, preprocessed, test data."</span></span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--model_input_folder"</span>, </span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"path to model folder."</span></span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--model_input_filename"</span>, </span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"name of model file."</span></span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder"</span>, </span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"path to output data *folder* with inference results."</span></span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename"</span>, </span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"name of file containing the output data with inference results."</span></span>
<span id="cb88-76"><a href="#cb88-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-77"><a href="#cb88-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-78"><a href="#cb88-78" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb88-79"><a href="#cb88-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-80"><a href="#cb88-80" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb88-81"><a href="#cb88-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-82"><a href="#cb88-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb88-83"><a href="#cb88-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-84"><a href="#cb88-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_and_inference (</span>
<span id="cb88-85"><a href="#cb88-85" aria-hidden="true" tabindex="-1"></a>    preprocessed_input_folder: <span class="bu">str</span>,</span>
<span id="cb88-86"><a href="#cb88-86" aria-hidden="true" tabindex="-1"></a>    preprocessed_input_filename: <span class="bu">str</span>,</span>
<span id="cb88-87"><a href="#cb88-87" aria-hidden="true" tabindex="-1"></a>    model_input_folder: <span class="bu">str</span>,</span>
<span id="cb88-88"><a href="#cb88-88" aria-hidden="true" tabindex="-1"></a>    model_input_filename: <span class="bu">str</span>,</span>
<span id="cb88-89"><a href="#cb88-89" aria-hidden="true" tabindex="-1"></a>    output_folder: <span class="bu">str</span>,    </span>
<span id="cb88-90"><a href="#cb88-90" aria-hidden="true" tabindex="-1"></a>    output_filename: <span class="bu">str</span>,</span>
<span id="cb88-91"><a href="#cb88-91" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb88-92"><a href="#cb88-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb88-93"><a href="#cb88-93" aria-hidden="true" tabindex="-1"></a><span class="co">    Reads test data and model, performs inference, and writes to output inference file.</span></span>
<span id="cb88-94"><a href="#cb88-94" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb88-95"><a href="#cb88-95" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb88-96"><a href="#cb88-96" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb88-97"><a href="#cb88-97" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessed_input_folder: str</span></span>
<span id="cb88-98"><a href="#cb88-98" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to test (preprocessed) data folder.</span></span>
<span id="cb88-99"><a href="#cb88-99" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessed_input_filename: str</span></span>
<span id="cb88-100"><a href="#cb88-100" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of test data file.</span></span>
<span id="cb88-101"><a href="#cb88-101" aria-hidden="true" tabindex="-1"></a><span class="co">    model_input_folder: str</span></span>
<span id="cb88-102"><a href="#cb88-102" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to built model folder.</span></span>
<span id="cb88-103"><a href="#cb88-103" aria-hidden="true" tabindex="-1"></a><span class="co">    model_input_filename: str</span></span>
<span id="cb88-104"><a href="#cb88-104" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to inference result folder.</span></span>
<span id="cb88-105"><a href="#cb88-105" aria-hidden="true" tabindex="-1"></a><span class="co">    output_folder: str</span></span>
<span id="cb88-106"><a href="#cb88-106" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to output data folder with inference results.</span></span>
<span id="cb88-107"><a href="#cb88-107" aria-hidden="true" tabindex="-1"></a><span class="co">    output_filename: str</span></span>
<span id="cb88-108"><a href="#cb88-108" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output data with inference results.</span></span>
<span id="cb88-109"><a href="#cb88-109" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb88-110"><a href="#cb88-110" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv (<span class="ss">f"</span><span class="sc">{</span>preprocessed_input_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>preprocessed_input_filename<span class="sc">}</span><span class="ss">"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb88-111"><a href="#cb88-111" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> joblib.load (<span class="ss">f"</span><span class="sc">{</span>model_input_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_input_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb88-112"><a href="#cb88-112" aria-hidden="true" tabindex="-1"></a>    z_df <span class="op">=</span> inference (model, df)</span>
<span id="cb88-113"><a href="#cb88-113" aria-hidden="true" tabindex="-1"></a>    z_df.to_csv (<span class="ss">f"</span><span class="sc">{</span>output_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>output_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb88-114"><a href="#cb88-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-115"><a href="#cb88-115" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb88-116"><a href="#cb88-116" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function of the script."""</span></span>
<span id="cb88-117"><a href="#cb88-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-118"><a href="#cb88-118" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb88-119"><a href="#cb88-119" aria-hidden="true" tabindex="-1"></a>    read_and_inference (</span>
<span id="cb88-120"><a href="#cb88-120" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>args.preprocessed_input_folder,</span>
<span id="cb88-121"><a href="#cb88-121" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>args.preprocessed_input_filename,</span>
<span id="cb88-122"><a href="#cb88-122" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>args.model_input_folder,</span>
<span id="cb88-123"><a href="#cb88-123" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>args.model_input_filename,</span>
<span id="cb88-124"><a href="#cb88-124" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>args.output_folder,</span>
<span id="cb88-125"><a href="#cb88-125" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>args.output_filename,</span>
<span id="cb88-126"><a href="#cb88-126" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-127"><a href="#cb88-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-128"><a href="#cb88-128" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb88-129"><a href="#cb88-129" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting inference/inference.py</code></pre>
</div>
</div>
<div id="a759377b" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>inference_command <span class="op">=</span> command(</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./inference/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python inference.py "</span> </span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--preprocessed_input_folder $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--preprocessed_input_filename $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--model_input_folder $</span><span class="sc">{{</span><span class="st">inputs.model_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--model_input_filename $</span><span class="sc">{{</span><span class="st">inputs.model_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st"> "</span>,</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"inference"</span>,</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>inference_component <span class="op">=</span> ml_client.create_or_update(inference_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Uploading inference (0.0 MBs): 100%|██████████| 4046/4046 [00:00&lt;00:00, 151355.71it/s]

</code></pre>
</div>
</div>
</section>
<section id="testing-the-pipeline-3" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-pipeline-3">Testing the pipeline</h3>
<p>Before submitting the pipeline job, it is very important to test it first, ideally with some dummy or small dataset. For this purpose, in the component implementation above, we have separated the code related with argument parsing and the rest of the code, which is in encapsulated in a function called <code>read_and_&lt;...&gt;</code>. This way, we can easily write a test pipeline before implementing the final one, as follows:</p>
<div id="1ad37bb6" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will need to change the code as we iteratively refine it </span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># while testing the pipeline. For that purpose, we use the </span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># reload module</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span> </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessing <span class="im">import</span> preprocessing</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training <span class="im">import</span> training</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> inference <span class="im">import</span> inference</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (preprocessing)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (training)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span> (inference)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_pipeline (</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, first component:</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file: <span class="bu">str</span>,</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_folder: <span class="bu">str</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename: <span class="bu">str</span>,</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, second component:</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file: <span class="bu">str</span>,</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_folder: <span class="bu">str</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename: <span class="bu">str</span>,</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># input_folder: this is preprocessing_training_output_folder</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># input_filename: this is preprocessing_training_output_filename</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>    training_output_folder: <span class="bu">str</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>    training_output_filename: <span class="bu">str</span>, </span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># preprocessed_input_folder: this is preprocessing_test_output_folder</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># preprocessed_input_filename: this is preprocessing_test_output_filename</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model_input_folder: this is training_output_folder</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model_input_filename: this is training_output_filename</span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>    inference_output_folder: <span class="bu">str</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>    inference_output_filename: <span class="bu">str</span>,</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Tests third pipeline: preprocessing, training and inference.</span></span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_input_file: str</span></span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing training data to be preprocessed.</span></span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_output_folder: str</span></span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to folder containing the preprocessed, training data file.</span></span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in final pipeline.</span></span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_output_filename: str</span></span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, training data.</span></span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Number to add to input data for preprocessing it.</span></span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_input_file: str</span></span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing test data to be preprocessed.</span></span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_output_folder: str</span></span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to folder containing the preprocessed, test data file.</span></span>
<span id="cb92-57"><a href="#cb92-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in final pipeline.</span></span>
<span id="cb92-58"><a href="#cb92-58" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_output_filename: str</span></span>
<span id="cb92-59"><a href="#cb92-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, test data.</span></span>
<span id="cb92-60"><a href="#cb92-60" aria-hidden="true" tabindex="-1"></a><span class="co">    training_output_folder: str</span></span>
<span id="cb92-61"><a href="#cb92-61" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to output folder containing the trained model.</span></span>
<span id="cb92-62"><a href="#cb92-62" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in final pipeline.</span></span>
<span id="cb92-63"><a href="#cb92-63" aria-hidden="true" tabindex="-1"></a><span class="co">    training_output_filename: str</span></span>
<span id="cb92-64"><a href="#cb92-64" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the trained model.</span></span>
<span id="cb92-65"><a href="#cb92-65" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_output_folder: str</span></span>
<span id="cb92-66"><a href="#cb92-66" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to output data folder with inference results.</span></span>
<span id="cb92-67"><a href="#cb92-67" aria-hidden="true" tabindex="-1"></a><span class="co">        Not present in final pipeline.</span></span>
<span id="cb92-68"><a href="#cb92-68" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_output_filename: str</span></span>
<span id="cb92-69"><a href="#cb92-69" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output data with inference results.</span></span>
<span id="cb92-70"><a href="#cb92-70" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb92-71"><a href="#cb92-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-72"><a href="#cb92-72" aria-hidden="true" tabindex="-1"></a>    preprocessing.read_and_preprocess (</span>
<span id="cb92-73"><a href="#cb92-73" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_training_input_file,</span>
<span id="cb92-74"><a href="#cb92-74" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>preprocessing_training_output_folder, <span class="co"># Not present in final component</span></span>
<span id="cb92-75"><a href="#cb92-75" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb92-76"><a href="#cb92-76" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb92-77"><a href="#cb92-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb92-78"><a href="#cb92-78" aria-hidden="true" tabindex="-1"></a>    preprocessing.read_and_preprocess (</span>
<span id="cb92-79"><a href="#cb92-79" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_test_input_file,</span>
<span id="cb92-80"><a href="#cb92-80" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>preprocessing_test_output_folder,</span>
<span id="cb92-81"><a href="#cb92-81" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb92-82"><a href="#cb92-82" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb92-83"><a href="#cb92-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb92-84"><a href="#cb92-84" aria-hidden="true" tabindex="-1"></a>    training.read_and_train (</span>
<span id="cb92-85"><a href="#cb92-85" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>preprocessing_training_output_folder,</span>
<span id="cb92-86"><a href="#cb92-86" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb92-87"><a href="#cb92-87" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>training_output_folder,</span>
<span id="cb92-88"><a href="#cb92-88" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb92-89"><a href="#cb92-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb92-90"><a href="#cb92-90" aria-hidden="true" tabindex="-1"></a>    inference.read_and_inference (</span>
<span id="cb92-91"><a href="#cb92-91" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>preprocessing_test_output_folder,</span>
<span id="cb92-92"><a href="#cb92-92" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb92-93"><a href="#cb92-93" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>training_output_folder,</span>
<span id="cb92-94"><a href="#cb92-94" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb92-95"><a href="#cb92-95" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>inference_output_folder,</span>
<span id="cb92-96"><a href="#cb92-96" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>inference_output_filename,</span>
<span id="cb92-97"><a href="#cb92-97" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb92-98"><a href="#cb92-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-99"><a href="#cb92-99" aria-hidden="true" tabindex="-1"></a>os.makedirs (<span class="st">"test_pipeline"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-100"><a href="#cb92-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-101"><a href="#cb92-101" aria-hidden="true" tabindex="-1"></a>test_pipeline (</span>
<span id="cb92-102"><a href="#cb92-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first preprocessing component</span></span>
<span id="cb92-103"><a href="#cb92-103" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>,</span>
<span id="cb92-104"><a href="#cb92-104" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_folder<span class="op">=</span><span class="st">"./test_pipeline"</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-105"><a href="#cb92-105" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename<span class="op">=</span><span class="st">"preprocessed_data.csv"</span>,</span>
<span id="cb92-106"><a href="#cb92-106" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb92-107"><a href="#cb92-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-108"><a href="#cb92-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># second preprocessing component</span></span>
<span id="cb92-109"><a href="#cb92-109" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file<span class="op">=</span><span class="st">"./data/dummy_test.csv"</span>,</span>
<span id="cb92-110"><a href="#cb92-110" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_folder<span class="op">=</span><span class="st">"./test_pipeline"</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-111"><a href="#cb92-111" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename<span class="op">=</span><span class="st">"preprocessed_test.csv"</span>,</span>
<span id="cb92-112"><a href="#cb92-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-113"><a href="#cb92-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb92-114"><a href="#cb92-114" aria-hidden="true" tabindex="-1"></a>    training_output_folder<span class="op">=</span><span class="st">"./test_pipeline"</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-115"><a href="#cb92-115" aria-hidden="true" tabindex="-1"></a>    training_output_filename<span class="op">=</span><span class="st">"model.pk"</span>,</span>
<span id="cb92-116"><a href="#cb92-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-117"><a href="#cb92-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb92-118"><a href="#cb92-118" aria-hidden="true" tabindex="-1"></a>    inference_output_folder<span class="op">=</span><span class="st">"./test_pipeline"</span>, <span class="co"># Not present in final pipeline</span></span>
<span id="cb92-119"><a href="#cb92-119" aria-hidden="true" tabindex="-1"></a>    inference_output_filename<span class="op">=</span><span class="st">"inference_result.csv"</span>,</span>
<span id="cb92-120"><a href="#cb92-120" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input
    a  b
0  1  4
1  2  5
2  3  6
Adding 10 to df
Output
     a   b
0  11  14
1  12  15
2  13  16
Input
       a     b
0  11.0  14.1
1  12.1  15.1
2  13.1  16.1
Adding 10 to df
Output
       a     b
0  21.0  24.1
1  22.1  25.1
2  23.1  26.1
Input
     a   b
0  11  14
1  12  15
2  13  16
mu:
 [12. 15.]
std:
 [1. 1.]
Inference result:
    distance
0  12.798828
1  14.283557
2  15.697771</code></pre>
</div>
</div>
</section>
<section id="pipeline-3" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-3">Pipeline</h3>
<div id="f8050551" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> three_components_pipeline(</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, first component:</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file: <span class="bu">str</span>,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename: <span class="bu">str</span>,</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, second component:</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file: <span class="bu">str</span>,</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename: <span class="bu">str</span>,</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    training_output_filename: <span class="bu">str</span>, </span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>    inference_output_filename: <span class="bu">str</span>,</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Third pipeline: preprocessing, training and inference.</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_input_file: str</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing training data to be preprocessed.</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_output_filename: str</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, training data.</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Number to add to input data for preprocessing it.</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_input_file: str</span></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing test data to be preprocessed.</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_output_filename: str</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, test data.</span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a><span class="co">    training_output_filename: str</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the trained model.</span></span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_output_filename: str</span></span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output data with inference results.</span></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_training_input_file,</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_test_input_file,</span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>preprocessing_training_job.outputs.output_folder,</span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a>    inference_job <span class="op">=</span> inference_component(</span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>preprocessing_test_job.outputs.output_folder,</span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>training_job.outputs.output_folder,</span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>inference_output_filename,</span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a>three_components_pipeline <span class="op">=</span> three_components_pipeline(</span>
<span id="cb94-70"><a href="#cb94-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first preprocessing component</span></span>
<span id="cb94-71"><a href="#cb94-71" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./data/dummy_input.csv"</span>),</span>
<span id="cb94-72"><a href="#cb94-72" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename<span class="op">=</span><span class="st">"preprocessed_training_data.csv"</span>,</span>
<span id="cb94-73"><a href="#cb94-73" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb94-74"><a href="#cb94-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-75"><a href="#cb94-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># second preprocessing component</span></span>
<span id="cb94-76"><a href="#cb94-76" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span><span class="st">"./data/dummy_test.csv"</span>),</span>
<span id="cb94-77"><a href="#cb94-77" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename<span class="op">=</span><span class="st">"preprocessed_test_data.csv"</span>,</span>
<span id="cb94-78"><a href="#cb94-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-79"><a href="#cb94-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb94-80"><a href="#cb94-80" aria-hidden="true" tabindex="-1"></a>    training_output_filename<span class="op">=</span><span class="st">"model.pk"</span>,</span>
<span id="cb94-81"><a href="#cb94-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-82"><a href="#cb94-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb94-83"><a href="#cb94-83" aria-hidden="true" tabindex="-1"></a>    inference_output_filename<span class="op">=</span><span class="st">"inference_results.csv"</span>,</span>
<span id="cb94-84"><a href="#cb94-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb94-85"><a href="#cb94-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-86"><a href="#cb94-86" aria-hidden="true" tabindex="-1"></a>three_components_pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb94-87"><a href="#cb94-87" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline,</span>
<span id="cb94-88"><a href="#cb94-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project's name</span></span>
<span id="cb94-89"><a href="#cb94-89" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"e2e_three_components_refactored"</span>,</span>
<span id="cb94-90"><a href="#cb94-90" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb94-91"><a href="#cb94-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-92"><a href="#cb94-92" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb94-93"><a href="#cb94-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb94-94"><a href="#cb94-94" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------------</span></span>
<span id="cb94-95"><a href="#cb94-95" aria-hidden="true" tabindex="-1"></a>ml_client.jobs.stream(three_components_pipeline_job.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RunId: blue_sugar_ns1v5dpj4c
Web View: https://ml.azure.com/runs/blue_sugar_ns1v5dpj4c?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-03-29 09:00:10Z] Completing processing run id 2319106a-3802-4727-8e58-c347521ab38f.
[2024-03-29 09:00:10Z] Completing processing run id caf9c677-ff96-4cd8-ac83-0439f16bc635.
[2024-03-29 09:00:11Z] Completing processing run id 3c7a3956-de79-4e6c-90d1-e012ed8ccaa8.
[2024-03-29 09:00:12Z] Submitting 1 runs, first five are: eeca7330:4a267c73-32ee-451d-9d53-b144842236ee
[2024-03-29 09:00:52Z] Completing processing run id 4a267c73-32ee-451d-9d53-b144842236ee.

Execution Summary
=================
RunId: blue_sugar_ns1v5dpj4c
Web View: https://ml.azure.com/runs/blue_sugar_ns1v5dpj4c?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<p>Here we can see the resulting pipeline:</p>
<p><img src="attachment:5e09eb0f-240d-4b9c-95d8-3b46c4047fbe.png" class="img-fluid"></p>
</section>
</section>
<section id="putting-everything-into-a-script" class="level2">
<h2 class="anchored" data-anchor-id="putting-everything-into-a-script">Putting everything into a script</h2>
<p>Let’s see how to put all the code needed for creating a pipeline into a script.</p>
<section id="config-json-file" class="level3">
<h3 class="anchored" data-anchor-id="config-json-file">config json file</h3>
<div id="5bcbc199" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile pipeline_input.json</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_training_input_file"</span>: <span class="st">"./data/dummy_input.csv"</span>,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_training_output_filename"</span>:<span class="st">"preprocessed_training_data.csv"</span>,</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"x"</span>: <span class="dv">10</span>,</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_test_input_file"</span>: <span class="st">"./data/dummy_test.csv"</span>,</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_test_output_filename"</span>: <span class="st">"preprocessed_test_data.csv"</span>,</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"training_output_filename"</span>: <span class="st">"model.pk"</span>,</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"inference_output_filename"</span>: <span class="st">"inference_results.csv"</span>,</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"experiment_name"</span>: <span class="st">"e2e_three_components_in_script"</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing pipeline_input.json</code></pre>
</div>
</div>
</section>
<section id="pipeline-script" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-script">pipeline script</h3>
<div id="5138a417" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world_pipeline.py</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imports</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Third-party imports</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> Bunch</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co"># AML imports</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> (</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    command,</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>    dsl,</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>    Input,</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>    Output,</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>    MLClient</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Connection</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="co"># authenticate</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a handle to the workspace</span></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>ml_client <span class="op">=</span> MLClient.from_config (</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>    credential<span class="op">=</span>credential</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Interface for each component</span></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocessing</span></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>preprocessing_command <span class="op">=</span> command(</span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python preprocessing.py "</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_file $</span><span class="sc">{{</span><span class="st">inputs.input_file</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"-x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> ml_client.create_or_update(preprocessing_command.component)</span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Training</span></span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>training_command <span class="op">=</span> command(</span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python training.py "</span></span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_folder $</span><span class="sc">{{</span><span class="st">inputs.input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--input_filename $</span><span class="sc">{{</span><span class="st">inputs.input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>training_component <span class="op">=</span> ml_client.create_or_update(training_command.component)</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Inference</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>inference_command <span class="op">=</span> command(</span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a>        output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="ss">f"./inference/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a>    command<span class="op">=</span><span class="st">"python inference.py "</span> </span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--preprocessed_input_folder $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--preprocessed_input_filename $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--model_input_folder $</span><span class="sc">{{</span><span class="st">inputs.model_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--model_input_filename $</span><span class="sc">{{</span><span class="st">inputs.model_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st"> "</span>,</span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"inference"</span>,</span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a>inference_component <span class="op">=</span> ml_client.create_or_update(inference_command.component)</span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline definition</span></span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb98-112"><a href="#cb98-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-113"><a href="#cb98-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> three_components_pipeline(</span>
<span id="cb98-114"><a href="#cb98-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, first component:</span></span>
<span id="cb98-115"><a href="#cb98-115" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file: <span class="bu">str</span>,</span>
<span id="cb98-116"><a href="#cb98-116" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename: <span class="bu">str</span>,</span>
<span id="cb98-117"><a href="#cb98-117" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb98-118"><a href="#cb98-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-119"><a href="#cb98-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, second component:</span></span>
<span id="cb98-120"><a href="#cb98-120" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file: <span class="bu">str</span>,</span>
<span id="cb98-121"><a href="#cb98-121" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename: <span class="bu">str</span>,</span>
<span id="cb98-122"><a href="#cb98-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-123"><a href="#cb98-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb98-124"><a href="#cb98-124" aria-hidden="true" tabindex="-1"></a>    training_output_filename: <span class="bu">str</span>, </span>
<span id="cb98-125"><a href="#cb98-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-126"><a href="#cb98-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb98-127"><a href="#cb98-127" aria-hidden="true" tabindex="-1"></a>    inference_output_filename: <span class="bu">str</span>,</span>
<span id="cb98-128"><a href="#cb98-128" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb98-129"><a href="#cb98-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb98-130"><a href="#cb98-130" aria-hidden="true" tabindex="-1"></a><span class="co">    Third pipeline: preprocessing, training and inference.</span></span>
<span id="cb98-131"><a href="#cb98-131" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb98-132"><a href="#cb98-132" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb98-133"><a href="#cb98-133" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb98-134"><a href="#cb98-134" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_input_file: str</span></span>
<span id="cb98-135"><a href="#cb98-135" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing training data to be preprocessed.</span></span>
<span id="cb98-136"><a href="#cb98-136" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_output_filename: str</span></span>
<span id="cb98-137"><a href="#cb98-137" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, training data.</span></span>
<span id="cb98-138"><a href="#cb98-138" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb98-139"><a href="#cb98-139" aria-hidden="true" tabindex="-1"></a><span class="co">        Number to add to input data for preprocessing it.</span></span>
<span id="cb98-140"><a href="#cb98-140" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_input_file: str</span></span>
<span id="cb98-141"><a href="#cb98-141" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing test data to be preprocessed.</span></span>
<span id="cb98-142"><a href="#cb98-142" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_output_filename: str</span></span>
<span id="cb98-143"><a href="#cb98-143" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, test data.</span></span>
<span id="cb98-144"><a href="#cb98-144" aria-hidden="true" tabindex="-1"></a><span class="co">    training_output_filename: str</span></span>
<span id="cb98-145"><a href="#cb98-145" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the trained model.</span></span>
<span id="cb98-146"><a href="#cb98-146" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_output_filename: str</span></span>
<span id="cb98-147"><a href="#cb98-147" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output data with inference results.</span></span>
<span id="cb98-148"><a href="#cb98-148" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb98-149"><a href="#cb98-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using data_prep_function like a python call with its own inputs</span></span>
<span id="cb98-150"><a href="#cb98-150" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb98-151"><a href="#cb98-151" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_training_input_file,</span>
<span id="cb98-152"><a href="#cb98-152" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb98-153"><a href="#cb98-153" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb98-154"><a href="#cb98-154" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb98-155"><a href="#cb98-155" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-156"><a href="#cb98-156" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb98-157"><a href="#cb98-157" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_test_input_file,</span>
<span id="cb98-158"><a href="#cb98-158" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb98-159"><a href="#cb98-159" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb98-160"><a href="#cb98-160" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb98-161"><a href="#cb98-161" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-162"><a href="#cb98-162" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb98-163"><a href="#cb98-163" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>preprocessing_training_job.outputs.output_folder,</span>
<span id="cb98-164"><a href="#cb98-164" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb98-165"><a href="#cb98-165" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb98-166"><a href="#cb98-166" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb98-167"><a href="#cb98-167" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-168"><a href="#cb98-168" aria-hidden="true" tabindex="-1"></a>    inference_job <span class="op">=</span> inference_component(</span>
<span id="cb98-169"><a href="#cb98-169" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>preprocessing_test_job.outputs.output_folder,</span>
<span id="cb98-170"><a href="#cb98-170" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb98-171"><a href="#cb98-171" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>training_job.outputs.output_folder,</span>
<span id="cb98-172"><a href="#cb98-172" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb98-173"><a href="#cb98-173" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb98-174"><a href="#cb98-174" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>inference_output_filename,</span>
<span id="cb98-175"><a href="#cb98-175" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-176"><a href="#cb98-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-177"><a href="#cb98-177" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-178"><a href="#cb98-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb98-179"><a href="#cb98-179" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-180"><a href="#cb98-180" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_pipeline (</span>
<span id="cb98-181"><a href="#cb98-181" aria-hidden="true" tabindex="-1"></a>    config_path: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline_input.json"</span>,</span>
<span id="cb98-182"><a href="#cb98-182" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb98-183"><a href="#cb98-183" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb98-184"><a href="#cb98-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-185"><a href="#cb98-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read config json file</span></span>
<span id="cb98-186"><a href="#cb98-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span> (config_path,<span class="st">"rt"</span>) <span class="im">as</span> config_file:</span>
<span id="cb98-187"><a href="#cb98-187" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> json.load (config_file)</span>
<span id="cb98-188"><a href="#cb98-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-189"><a href="#cb98-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert config dictionary into a Bunch object. This is a </span></span>
<span id="cb98-190"><a href="#cb98-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sub-class of dict which allows to get access to fields </span></span>
<span id="cb98-191"><a href="#cb98-191" aria-hidden="true" tabindex="-1"></a>    <span class="co"># as object attributes (a bit more convenient IMO) in addition </span></span>
<span id="cb98-192"><a href="#cb98-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to also allowing the dict syntax.</span></span>
<span id="cb98-193"><a href="#cb98-193" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> Bunch (<span class="op">**</span>config)</span>
<span id="cb98-194"><a href="#cb98-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-195"><a href="#cb98-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build pipeline </span></span>
<span id="cb98-196"><a href="#cb98-196" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline_object <span class="op">=</span> three_components_pipeline(</span>
<span id="cb98-197"><a href="#cb98-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># first preprocessing component</span></span>
<span id="cb98-198"><a href="#cb98-198" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_training_input_file),</span>
<span id="cb98-199"><a href="#cb98-199" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_output_filename<span class="op">=</span>config.preprocessing_training_output_filename,</span>
<span id="cb98-200"><a href="#cb98-200" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>config.x,</span>
<span id="cb98-201"><a href="#cb98-201" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-202"><a href="#cb98-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># second preprocessing component</span></span>
<span id="cb98-203"><a href="#cb98-203" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_test_input_file),</span>
<span id="cb98-204"><a href="#cb98-204" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_output_filename<span class="op">=</span>config.preprocessing_test_output_filename,</span>
<span id="cb98-205"><a href="#cb98-205" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-206"><a href="#cb98-206" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training component parameters:</span></span>
<span id="cb98-207"><a href="#cb98-207" aria-hidden="true" tabindex="-1"></a>        training_output_filename<span class="op">=</span>config.training_output_filename,</span>
<span id="cb98-208"><a href="#cb98-208" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-209"><a href="#cb98-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Inference component parameters:</span></span>
<span id="cb98-210"><a href="#cb98-210" aria-hidden="true" tabindex="-1"></a>        inference_output_filename<span class="op">=</span>config.inference_output_filename,</span>
<span id="cb98-211"><a href="#cb98-211" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-212"><a href="#cb98-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-213"><a href="#cb98-213" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb98-214"><a href="#cb98-214" aria-hidden="true" tabindex="-1"></a>        three_components_pipeline_object,</span>
<span id="cb98-215"><a href="#cb98-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project's name</span></span>
<span id="cb98-216"><a href="#cb98-216" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb98-217"><a href="#cb98-217" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-218"><a href="#cb98-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-219"><a href="#cb98-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb98-220"><a href="#cb98-220" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pipeline running</span></span>
<span id="cb98-221"><a href="#cb98-221" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb98-222"><a href="#cb98-222" aria-hidden="true" tabindex="-1"></a>    ml_client.jobs.stream(three_components_pipeline_job.name)</span>
<span id="cb98-223"><a href="#cb98-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-224"><a href="#cb98-224" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-225"><a href="#cb98-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Parsing</span></span>
<span id="cb98-226"><a href="#cb98-226" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-227"><a href="#cb98-227" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb98-228"><a href="#cb98-228" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb98-229"><a href="#cb98-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-230"><a href="#cb98-230" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb98-231"><a href="#cb98-231" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb98-232"><a href="#cb98-232" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--config-path"</span>, </span>
<span id="cb98-233"><a href="#cb98-233" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb98-234"><a href="#cb98-234" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"pipeline_input.json"</span>,</span>
<span id="cb98-235"><a href="#cb98-235" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Path to config file specifying pipeline input parameters."</span>,</span>
<span id="cb98-236"><a href="#cb98-236" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-237"><a href="#cb98-237" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb98-238"><a href="#cb98-238" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--experiment-name"</span>, </span>
<span id="cb98-239"><a href="#cb98-239" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb98-240"><a href="#cb98-240" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb98-241"><a href="#cb98-241" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of experiment."</span>,</span>
<span id="cb98-242"><a href="#cb98-242" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-243"><a href="#cb98-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-244"><a href="#cb98-244" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb98-245"><a href="#cb98-245" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-246"><a href="#cb98-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb98-247"><a href="#cb98-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-248"><a href="#cb98-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-249"><a href="#cb98-249" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-250"><a href="#cb98-250" aria-hidden="true" tabindex="-1"></a><span class="co"># main</span></span>
<span id="cb98-251"><a href="#cb98-251" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-252"><a href="#cb98-252" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main ():</span>
<span id="cb98-253"><a href="#cb98-253" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses arguments and runs pipeline"""</span></span>
<span id="cb98-254"><a href="#cb98-254" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb98-255"><a href="#cb98-255" aria-hidden="true" tabindex="-1"></a>    run_pipeline (</span>
<span id="cb98-256"><a href="#cb98-256" aria-hidden="true" tabindex="-1"></a>        args.config_path,</span>
<span id="cb98-257"><a href="#cb98-257" aria-hidden="true" tabindex="-1"></a>        args.experiment_name,</span>
<span id="cb98-258"><a href="#cb98-258" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-259"><a href="#cb98-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-260"><a href="#cb98-260" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-261"><a href="#cb98-261" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb98-262"><a href="#cb98-262" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb98-263"><a href="#cb98-263" aria-hidden="true" tabindex="-1"></a>    main ()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting hello_world_pipeline.py</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Bad pipe message: %s [b'1~\xd1B\xe9k\xf8\x8beF\x0bi8_~\n\xa2F \xfec\x82\xc3\xb3^P&amp;\xb5A\xd2\xbb\xa6\xb1\xc5\xef\x04\xb7C\xa9\xeb\xb2U\xed\x81\x80M\x05\xf7\x85H\xc8\x00\x08\x13\x02\x13\x03\x13\x01\x00\xff\x01\x00\x00\x8f\x00\x00\x00\x0e\x00\x0c\x00\x00\t127.0.0.1\x00\x0b\x00\x04\x03\x00\x01\x02\x00\n\x00\x0c\x00\n\x00\x1d\x00\x17\x00\x1e\x00\x19\x00\x18\x00#\x00\x00\x00\x16\x00\x00\x00\x17\x00\x00\x00\r\x00\x1e\x00']
Bad pipe message: %s [b'\x03\x05\x03\x06\x03\x08\x07\x08\x08\x08\t\x08\n\x08\x0b\x08\x04\x08\x05\x08\x06\x04\x01\x05\x01\x06\x01']
Bad pipe message: %s [b"\xcd\xe4\xaew\x91`\x94\xc6fO\xea\x92 \xc7b\xb15G\x00\x00|\xc0,\xc00\x00\xa3\x00\x9f\xcc\xa9\xcc\xa8\xcc\xaa\xc0\xaf\xc0\xad\xc0\xa3\xc0\x9f\xc0]\xc0a\xc0W\xc0S\xc0+\xc0/\x00\xa2\x00\x9e\xc0\xae\xc0\xac\xc0\xa2\xc0\x9e\xc0\\\xc0`\xc0V\xc0R\xc0$\xc0(\x00k\x00j\xc0#\xc0'\x00g\x00@\xc0\n\xc0\x14\x009\x008\xc0\t\xc0\x13\x003\x002\x00\x9d\xc0\xa1\xc0\x9d\xc0Q\x00\x9c\xc0\xa0\xc0\x9c\xc0P\x00=\x00&lt;\x005\x00/\x00\x9a\x00\x99\xc0\x07\xc0\x11\x00\x96\x00\x05\x00\xff\x01\x00\x00j\x00\x00\x00\x0e\x00\x0c\x00\x00\t127.0.0.1\x00\x0b\x00\x04\x03\x00\x01\x02\x00\n\x00\x0c\x00\n\x00\x1d\x00\x17\x00\x1e\x00\x19\x00\x18\x00#\x00\x00\x00\x16\x00\x00\x00\x17\x00\x00\x00\r\x000\x00.\x04\x03\x05\x03\x06\x03\x08\x07\x08\x08\x08\t\x08\n\x08\x0b\x08\x04\x08\x05\x08\x06\x04\x01\x05\x01\x06\x01\x03\x03\x02\x03\x03\x01\x02\x01\x03", b'\x02']
Bad pipe message: %s [b'\x05\x02\x06']
Bad pipe message: %s [b'\x0b"a7\xfa\xa1#\xf3\x88\xcc%\xae\xb45\xbc\xdbY\xb8\x00\x00\xa6\xc0,\xc00\x00\xa3\x00\x9f\xcc\xa9\xcc\xa8\xcc\xaa\xc0\xaf\xc0\xad\xc0\xa3\xc0\x9f\xc0]\xc0a\xc0W\xc0S\xc0+\xc0/\x00\xa2\x00\x9e\xc0\xae\xc0\xac\xc0\xa2\xc0\x9e\xc0\\\xc0`\xc0V\xc0R\xc0$\xc0(\x00k\x00j\xc0s\xc0w\x00\xc4\x00\xc3\xc0#\xc0\'\x00g\x00@\xc0r\xc0v\x00\xbe\x00\xbd\xc0\n\xc0\x14\x009\x008\x00\x88\x00\x87\xc0\t\xc0\x13\x003\x002\x00\x9a\x00\x99\x00E\x00D\xc0\x07\xc0\x11\xc0\x08\xc0\x12\x00\x16\x00\x13\x00\x9d\xc0\xa1\xc0\x9d\xc0Q\x00\x9c\xc0\xa0\xc0\x9c\xc0P\x00=\x00\xc0\x00&lt;\x00\xba\x005\x00\x84\x00/\x00\x96\x00A\x00\x05\x00']
Bad pipe message: %s [b'\xff\x01\x00\x00j\x00\x00\x00\x0e']
Bad pipe message: %s [b'7\x992kK\xc1\xdbF\x8b\xb1\xe1l\x19\xbfA&lt;\x1fc\x00\x00&gt;\xc0\x14\xc0\n\x009\x008\x007\x006\xc0\x0f\xc0\x05\x005\xc0\x13\xc0\t\x003\x002\x001\x000\xc0\x0e\xc0\x04\x00/\x00\x9a\x00\x99\x00\x98\x00\x97\x00\x96\x00\x07\xc0\x11\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\x00\xff\x02\x01\x00\x00C\x00\x00\x00\x0e\x00\x0c\x00\x00\t127.0.0.1\x00\x0b\x00\x04\x03\x00\x01\x02']
Bad pipe message: %s [b'\xcf\xf4\xe1\xe6\xec\xa7$\x0f\x95\xd8\xe3X\xfcm\x93\xc2\x06?\x00\x00\xa2\xc0\x14\xc0\n\x009\x008\x007\x006\x00\x88\x00\x87\x00\x86\x00\x85\xc0\x19\x00:\x00\x89\xc0\x0f\xc0\x05\x005\x00\x84\xc0\x13\xc0\t\x003\x002\x001\x000\x00\x9a\x00\x99\x00\x98\x00\x97\x00E\x00D\x00C\x00B\xc0\x18\x004\x00\x9b\x00F\xc0\x0e\xc0\x04\x00/\x00\x96\x00A\x00\x07\xc0\x11\xc0\x07\xc0\x16\x00\x18\xc0\x0c\xc0\x02\x00\x05\x00\x04\xc0\x12\xc0\x08\x00\x16\x00\x13\x00', b'\r\xc0\x17\x00\x1b\xc0\r\xc0\x03\x00\n\x00\x15\x00\x12']
Bad pipe message: %s [b'Nv\xa8\xf4\x13\xe0t\x12q\xe1\xb8\xa4\xe0(\xaflvv']
Bad pipe message: %s [b'\xd5\xc3({`3.\xe2\xad\xa8.6\x01\xe9\xb4\x06\xba\xb1\x00\x00&gt;\xc0\x14\xc0\n\x009\x008\x007\x006\xc0\x0f\xc0\x05\x005\xc0\x13\xc0\t\x003\x002\x001\x000\xc0\x0e\xc0\x04\x00/\x00\x9a\x00\x99\x00\x98\x00\x97\x00\x96\x00\x07\xc0\x11\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\x00\xff\x02\x01\x00\x15\x03\x00']
Bad pipe message: %s [b"\xa7\xe2\x12\x89\xeaUh\xb9\x1a\xc3\x92\x85\x1f\xd4\xf7\xaf\xb4\xcd\x00\x00\x86\xc00\xc0,\xc0(\xc0$\xc0\x14\xc0\n\x00\xa5\x00\xa3\x00\xa1\x00\x9f\x00k\x00j\x00i\x00h\x009\x008\x007\x006\xc02\xc0.\xc0*\xc0&amp;\xc0\x0f\xc0\x05\x00\x9d\x00=\x005\xc0/\xc0+\xc0'\xc0#\xc0\x13\xc0\t\x00\xa4\x00\xa2\x00\xa0\x00\x9e\x00g\x00@\x00?\x00&gt;\x003\x002\x001\x000\xc01\xc0-\xc0)\xc0%\xc0\x0e\xc0\x04\x00\x9c\x00&lt;\x00/\x00\x9a\x00\x99\x00\x98\x00\x97\x00\x96\x00\x07\xc0\x11\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\x00\xff\x02\x01\x00\x00g\x00\x00\x00\x0e\x00\x0c\x00\x00\t127.0.0.1\x00\x0b\x00\x04\x03\x00\x01\x02\x00\n\x00\x1c\x00\x1a\x00\x17\x00\x19\x00\x1c\x00\x1b\x00\x18\x00\x1a\x00\x16\x00\x0e\x00\r\x00\x0b\x00\x0c\x00\t\x00\n\x00#\x00\x00\x00\r\x00 \x00\x1e\x06\x01\x06\x02\x06\x03\x05\x01\x05\x02\x05\x03\x04\x01\x04\x02", b'\x03\x01\x03', b'\x03', b'\x02', b'\x03']
Bad pipe message: %s [b'\xc7\x95X[|\x00\xb9,o\xa7\x95\xdd\xee\xd3A\xd2g\x06\x00\x00\xf4\xc00\xc0,\xc0(\xc0$\xc0\x14\xc0\n\x00\xa5\x00\xa3\x00\xa1\x00\x9f\x00k\x00j\x00i\x00h\x009\x008\x007\x006\x00\x88\x00\x87\x00\x86\x00\x85\xc0\x19\x00\xa7\x00', b":\x00\x89\xc02\xc0.\xc0*\xc0&amp;\xc0\x0f\xc0\x05\x00\x9d\x00=\x005\x00\x84\xc0/\xc0+\xc0'\xc0#\xc0\x13\xc0\t\x00\xa4\x00\xa2\x00\xa0\x00\x9e\x00g\x00@\x00?\x00&gt;\x003\x002\x001\x000\x00\x9a\x00\x99\x00\x98\x00\x97\x00E\x00D\x00C\x00B\xc0\x18\x00\xa6\x00l\x004\x00\x9b\x00F\xc01\xc0-\xc0)\xc0%\xc0\x0e\xc0\x04\x00\x9c\x00&lt;\x00/\x00\x96\x00"]
Bad pipe message: %s [b'\x07\xc0\x11\xc0\x07\xc0\x16\x00\x18\xc0\x0c\xc0\x02\x00\x05\x00\x04\xc0\x12\xc0\x08\x00\x16\x00\x13\x00\x10\x00\r\xc0\x17\x00\x1b\xc0\r\xc0\x03\x00\n\x00\x15\x00\x12\x00\x0f\x00\x0c\x00\x1a\x00\t\x00\x14\x00\x11\x00\x19\x00\x08\x00\x06\x00\x17\x00']
Bad pipe message: %s [b'\x10\xc0']
Bad pipe message: %s [b'\x15\xc0\x0b\xc0\x01']</code></pre>
</div>
</div>
<p>We can now run the script from command line:</p>
<p>First we open up a terminal and activate a conda environment that uses the python SDK version 2. Let’s see what environments we currently have:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As of now, this provides the following list:</p>
<pre><code># conda environments:
#
base                     /anaconda
azureml_py310_sdkv2      /anaconda/envs/azureml_py310_sdkv2
azureml_py38          *  /anaconda/envs/azureml_py38
azureml_py38_PT_TF       /anaconda/envs/azureml_py38_PT_TF
jupyter_env              /anaconda/envs/jupyter_env</code></pre>
<p>From that list, the conda environment using SDK v2 is <code>azureml_py310_sdkv2</code> (use another if that changes when you read this)</p>
<p>We activate it and run our script:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate azureml_py310_sdkv2</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> hello_world_pipeline.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="removing-global-variables" class="level3">
<h3 class="anchored" data-anchor-id="removing-global-variables">Removing global variables</h3>
<p>Let’s introduce two optional changes:</p>
<ul>
<li>Instead of defining the <code>preprocessing_command</code>, <code>training_command</code> and <code>inference_command</code> out of the pipeline function, we will define them inside.</li>
<li>We will avoid creating the components beforehand, by not calling <code>ml_client.create_or_update (my_component_command.component)</code>, as it was done for example here:</li>
</ul>
<div class="sourceCode" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> ml_client.create_or_update(preprocessing_command.component)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="3b093697" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world_pipeline.py</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imports</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Third-party imports</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> Bunch</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="co"># AML imports</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> (</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    command,</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>    dsl,</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>    Input,</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>    Output,</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>    MLClient</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Connection</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="ex">connect</span> ():</span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># authenticate</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>    credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a handle to the workspace</span></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>    ml_client <span class="op">=</span> MLClient.from_config (</span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>        credential<span class="op">=</span>credential,</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ml_client</span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline definition</span></span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a>    compute<span class="op">=</span><span class="st">"serverless"</span>,  <span class="co"># "serverless" value runs pipeline on serverless compute</span></span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-44"><a href="#cb105-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> three_components_pipeline(</span>
<span id="cb105-45"><a href="#cb105-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, first component:</span></span>
<span id="cb105-46"><a href="#cb105-46" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file: <span class="bu">str</span>,</span>
<span id="cb105-47"><a href="#cb105-47" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename: <span class="bu">str</span>,</span>
<span id="cb105-48"><a href="#cb105-48" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb105-49"><a href="#cb105-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-50"><a href="#cb105-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, second component:</span></span>
<span id="cb105-51"><a href="#cb105-51" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file: <span class="bu">str</span>,</span>
<span id="cb105-52"><a href="#cb105-52" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename: <span class="bu">str</span>,</span>
<span id="cb105-53"><a href="#cb105-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-54"><a href="#cb105-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb105-55"><a href="#cb105-55" aria-hidden="true" tabindex="-1"></a>    training_output_filename: <span class="bu">str</span>, </span>
<span id="cb105-56"><a href="#cb105-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-57"><a href="#cb105-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb105-58"><a href="#cb105-58" aria-hidden="true" tabindex="-1"></a>    inference_output_filename: <span class="bu">str</span>,</span>
<span id="cb105-59"><a href="#cb105-59" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb105-60"><a href="#cb105-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb105-61"><a href="#cb105-61" aria-hidden="true" tabindex="-1"></a><span class="co">    Third pipeline: preprocessing, training and inference.</span></span>
<span id="cb105-62"><a href="#cb105-62" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb105-63"><a href="#cb105-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb105-64"><a href="#cb105-64" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb105-65"><a href="#cb105-65" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_input_file: str</span></span>
<span id="cb105-66"><a href="#cb105-66" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing training data to be preprocessed.</span></span>
<span id="cb105-67"><a href="#cb105-67" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_output_filename: str</span></span>
<span id="cb105-68"><a href="#cb105-68" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, training data.</span></span>
<span id="cb105-69"><a href="#cb105-69" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb105-70"><a href="#cb105-70" aria-hidden="true" tabindex="-1"></a><span class="co">        Number to add to input data for preprocessing it.</span></span>
<span id="cb105-71"><a href="#cb105-71" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_input_file: str</span></span>
<span id="cb105-72"><a href="#cb105-72" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing test data to be preprocessed.</span></span>
<span id="cb105-73"><a href="#cb105-73" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_output_filename: str</span></span>
<span id="cb105-74"><a href="#cb105-74" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, test data.</span></span>
<span id="cb105-75"><a href="#cb105-75" aria-hidden="true" tabindex="-1"></a><span class="co">    training_output_filename: str</span></span>
<span id="cb105-76"><a href="#cb105-76" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the trained model.</span></span>
<span id="cb105-77"><a href="#cb105-77" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_output_filename: str</span></span>
<span id="cb105-78"><a href="#cb105-78" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output data with inference results.</span></span>
<span id="cb105-79"><a href="#cb105-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb105-80"><a href="#cb105-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-81"><a href="#cb105-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (</span>
<span id="cb105-82"><a href="#cb105-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Running hello-world pipeline with args"</span>, </span>
<span id="cb105-83"><a href="#cb105-83" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_input_file,</span>
<span id="cb105-84"><a href="#cb105-84" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_output_filename,</span>
<span id="cb105-85"><a href="#cb105-85" aria-hidden="true" tabindex="-1"></a>        x,</span>
<span id="cb105-86"><a href="#cb105-86" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_input_file,</span>
<span id="cb105-87"><a href="#cb105-87" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_output_filename,</span>
<span id="cb105-88"><a href="#cb105-88" aria-hidden="true" tabindex="-1"></a>        training_output_filename,</span>
<span id="cb105-89"><a href="#cb105-89" aria-hidden="true" tabindex="-1"></a>        inference_output_filename,</span>
<span id="cb105-90"><a href="#cb105-90" aria-hidden="true" tabindex="-1"></a>        sep<span class="op">=</span><span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb105-91"><a href="#cb105-91" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-92"><a href="#cb105-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-93"><a href="#cb105-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-94"><a href="#cb105-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing</span></span>
<span id="cb105-95"><a href="#cb105-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-96"><a href="#cb105-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interface</span></span>
<span id="cb105-97"><a href="#cb105-97" aria-hidden="true" tabindex="-1"></a>    preprocessing_component <span class="op">=</span> command(</span>
<span id="cb105-98"><a href="#cb105-98" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb105-99"><a href="#cb105-99" aria-hidden="true" tabindex="-1"></a>            input_file<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb105-100"><a href="#cb105-100" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb105-101"><a href="#cb105-101" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb105-102"><a href="#cb105-102" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb105-103"><a href="#cb105-103" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb105-104"><a href="#cb105-104" aria-hidden="true" tabindex="-1"></a>            output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb105-105"><a href="#cb105-105" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb105-106"><a href="#cb105-106" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb105-107"><a href="#cb105-107" aria-hidden="true" tabindex="-1"></a>        command<span class="op">=</span><span class="st">"python preprocessing.py "</span></span>
<span id="cb105-108"><a href="#cb105-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input_file $</span><span class="sc">{{</span><span class="st">inputs.input_file</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-109"><a href="#cb105-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">"-x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-110"><a href="#cb105-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-111"><a href="#cb105-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb105-112"><a href="#cb105-112" aria-hidden="true" tabindex="-1"></a>        environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb105-113"><a href="#cb105-113" aria-hidden="true" tabindex="-1"></a>        display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb105-114"><a href="#cb105-114" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-115"><a href="#cb105-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-116"><a href="#cb105-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiation</span></span>
<span id="cb105-117"><a href="#cb105-117" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb105-118"><a href="#cb105-118" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_training_input_file,</span>
<span id="cb105-119"><a href="#cb105-119" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb105-120"><a href="#cb105-120" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb105-121"><a href="#cb105-121" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb105-122"><a href="#cb105-122" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-123"><a href="#cb105-123" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb105-124"><a href="#cb105-124" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_test_input_file,</span>
<span id="cb105-125"><a href="#cb105-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb105-126"><a href="#cb105-126" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb105-127"><a href="#cb105-127" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb105-128"><a href="#cb105-128" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-129"><a href="#cb105-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-130"><a href="#cb105-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-131"><a href="#cb105-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component</span></span>
<span id="cb105-132"><a href="#cb105-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-133"><a href="#cb105-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interface</span></span>
<span id="cb105-134"><a href="#cb105-134" aria-hidden="true" tabindex="-1"></a>    training_component <span class="op">=</span> command(</span>
<span id="cb105-135"><a href="#cb105-135" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb105-136"><a href="#cb105-136" aria-hidden="true" tabindex="-1"></a>            input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb105-137"><a href="#cb105-137" aria-hidden="true" tabindex="-1"></a>            input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb105-138"><a href="#cb105-138" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb105-139"><a href="#cb105-139" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb105-140"><a href="#cb105-140" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb105-141"><a href="#cb105-141" aria-hidden="true" tabindex="-1"></a>            output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb105-142"><a href="#cb105-142" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb105-143"><a href="#cb105-143" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb105-144"><a href="#cb105-144" aria-hidden="true" tabindex="-1"></a>        command<span class="op">=</span><span class="st">"python training.py "</span></span>
<span id="cb105-145"><a href="#cb105-145" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input_folder $</span><span class="sc">{{</span><span class="st">inputs.input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-146"><a href="#cb105-146" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input_filename $</span><span class="sc">{{</span><span class="st">inputs.input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-147"><a href="#cb105-147" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-148"><a href="#cb105-148" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb105-149"><a href="#cb105-149" aria-hidden="true" tabindex="-1"></a>        environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb105-150"><a href="#cb105-150" aria-hidden="true" tabindex="-1"></a>        display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb105-151"><a href="#cb105-151" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-152"><a href="#cb105-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-153"><a href="#cb105-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiation</span></span>
<span id="cb105-154"><a href="#cb105-154" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb105-155"><a href="#cb105-155" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>preprocessing_training_job.outputs.output_folder,</span>
<span id="cb105-156"><a href="#cb105-156" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb105-157"><a href="#cb105-157" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb105-158"><a href="#cb105-158" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb105-159"><a href="#cb105-159" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-160"><a href="#cb105-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-161"><a href="#cb105-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-162"><a href="#cb105-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference</span></span>
<span id="cb105-163"><a href="#cb105-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-164"><a href="#cb105-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interface</span></span>
<span id="cb105-165"><a href="#cb105-165" aria-hidden="true" tabindex="-1"></a>    inference_component <span class="op">=</span> command(</span>
<span id="cb105-166"><a href="#cb105-166" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb105-167"><a href="#cb105-167" aria-hidden="true" tabindex="-1"></a>            preprocessed_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb105-168"><a href="#cb105-168" aria-hidden="true" tabindex="-1"></a>            preprocessed_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb105-169"><a href="#cb105-169" aria-hidden="true" tabindex="-1"></a>            model_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb105-170"><a href="#cb105-170" aria-hidden="true" tabindex="-1"></a>            model_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb105-171"><a href="#cb105-171" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb105-172"><a href="#cb105-172" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb105-173"><a href="#cb105-173" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb105-174"><a href="#cb105-174" aria-hidden="true" tabindex="-1"></a>            output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb105-175"><a href="#cb105-175" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb105-176"><a href="#cb105-176" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"./inference/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb105-177"><a href="#cb105-177" aria-hidden="true" tabindex="-1"></a>        command<span class="op">=</span><span class="st">"python inference.py "</span> </span>
<span id="cb105-178"><a href="#cb105-178" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--preprocessed_input_folder $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-179"><a href="#cb105-179" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--preprocessed_input_filename $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-180"><a href="#cb105-180" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--model_input_folder $</span><span class="sc">{{</span><span class="st">inputs.model_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-181"><a href="#cb105-181" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--model_input_filename $</span><span class="sc">{{</span><span class="st">inputs.model_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-182"><a href="#cb105-182" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb105-183"><a href="#cb105-183" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st"> "</span>,</span>
<span id="cb105-184"><a href="#cb105-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-185"><a href="#cb105-185" aria-hidden="true" tabindex="-1"></a>        environment<span class="op">=</span><span class="st">"AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</span>,</span>
<span id="cb105-186"><a href="#cb105-186" aria-hidden="true" tabindex="-1"></a>        display_name<span class="op">=</span><span class="st">"inference"</span>,</span>
<span id="cb105-187"><a href="#cb105-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-188"><a href="#cb105-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-189"><a href="#cb105-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiation</span></span>
<span id="cb105-190"><a href="#cb105-190" aria-hidden="true" tabindex="-1"></a>    inference_job <span class="op">=</span> inference_component(</span>
<span id="cb105-191"><a href="#cb105-191" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>preprocessing_test_job.outputs.output_folder,</span>
<span id="cb105-192"><a href="#cb105-192" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb105-193"><a href="#cb105-193" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>training_job.outputs.output_folder,</span>
<span id="cb105-194"><a href="#cb105-194" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb105-195"><a href="#cb105-195" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb105-196"><a href="#cb105-196" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>inference_output_filename,</span>
<span id="cb105-197"><a href="#cb105-197" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-198"><a href="#cb105-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-199"><a href="#cb105-199" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-200"><a href="#cb105-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb105-201"><a href="#cb105-201" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-202"><a href="#cb105-202" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_pipeline (</span>
<span id="cb105-203"><a href="#cb105-203" aria-hidden="true" tabindex="-1"></a>    config_path: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline_input.json"</span>,</span>
<span id="cb105-204"><a href="#cb105-204" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb105-205"><a href="#cb105-205" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb105-206"><a href="#cb105-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-207"><a href="#cb105-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read config json file</span></span>
<span id="cb105-208"><a href="#cb105-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span> (config_path,<span class="st">"rt"</span>) <span class="im">as</span> config_file:</span>
<span id="cb105-209"><a href="#cb105-209" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> json.load (config_file)</span>
<span id="cb105-210"><a href="#cb105-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-211"><a href="#cb105-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert config dictionary into a Bunch object.</span></span>
<span id="cb105-212"><a href="#cb105-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This allows to get access to fields as object attributes</span></span>
<span id="cb105-213"><a href="#cb105-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Which I find more convenient.</span></span>
<span id="cb105-214"><a href="#cb105-214" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> Bunch (<span class="op">**</span>config)</span>
<span id="cb105-215"><a href="#cb105-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-216"><a href="#cb105-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect to AML client</span></span>
<span id="cb105-217"><a href="#cb105-217" aria-hidden="true" tabindex="-1"></a>    ml_client <span class="op">=</span> <span class="ex">connect</span> ()</span>
<span id="cb105-218"><a href="#cb105-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-219"><a href="#cb105-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build pipeline </span></span>
<span id="cb105-220"><a href="#cb105-220" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline_object <span class="op">=</span> three_components_pipeline(</span>
<span id="cb105-221"><a href="#cb105-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># first preprocessing component</span></span>
<span id="cb105-222"><a href="#cb105-222" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_training_input_file),</span>
<span id="cb105-223"><a href="#cb105-223" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_output_filename<span class="op">=</span>config.preprocessing_training_output_filename,</span>
<span id="cb105-224"><a href="#cb105-224" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>config.x,</span>
<span id="cb105-225"><a href="#cb105-225" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb105-226"><a href="#cb105-226" aria-hidden="true" tabindex="-1"></a>        <span class="co"># second preprocessing component</span></span>
<span id="cb105-227"><a href="#cb105-227" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_test_input_file),</span>
<span id="cb105-228"><a href="#cb105-228" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_output_filename<span class="op">=</span>config.preprocessing_test_output_filename,</span>
<span id="cb105-229"><a href="#cb105-229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb105-230"><a href="#cb105-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training component parameters:</span></span>
<span id="cb105-231"><a href="#cb105-231" aria-hidden="true" tabindex="-1"></a>        training_output_filename<span class="op">=</span>config.training_output_filename,</span>
<span id="cb105-232"><a href="#cb105-232" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb105-233"><a href="#cb105-233" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Inference component parameters:</span></span>
<span id="cb105-234"><a href="#cb105-234" aria-hidden="true" tabindex="-1"></a>        inference_output_filename<span class="op">=</span>config.inference_output_filename,</span>
<span id="cb105-235"><a href="#cb105-235" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-236"><a href="#cb105-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-237"><a href="#cb105-237" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb105-238"><a href="#cb105-238" aria-hidden="true" tabindex="-1"></a>        three_components_pipeline_object,</span>
<span id="cb105-239"><a href="#cb105-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project's name</span></span>
<span id="cb105-240"><a href="#cb105-240" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb105-241"><a href="#cb105-241" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-242"><a href="#cb105-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-243"><a href="#cb105-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb105-244"><a href="#cb105-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pipeline running</span></span>
<span id="cb105-245"><a href="#cb105-245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb105-246"><a href="#cb105-246" aria-hidden="true" tabindex="-1"></a>    ml_client.jobs.stream(three_components_pipeline_job.name)</span>
<span id="cb105-247"><a href="#cb105-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-248"><a href="#cb105-248" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-249"><a href="#cb105-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Parsing</span></span>
<span id="cb105-250"><a href="#cb105-250" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-251"><a href="#cb105-251" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb105-252"><a href="#cb105-252" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb105-253"><a href="#cb105-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-254"><a href="#cb105-254" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb105-255"><a href="#cb105-255" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb105-256"><a href="#cb105-256" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--config-path"</span>, </span>
<span id="cb105-257"><a href="#cb105-257" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb105-258"><a href="#cb105-258" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"pipeline_input.json"</span>,</span>
<span id="cb105-259"><a href="#cb105-259" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Path to config file specifying pipeline input parameters."</span>,</span>
<span id="cb105-260"><a href="#cb105-260" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-261"><a href="#cb105-261" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb105-262"><a href="#cb105-262" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--experiment-name"</span>, </span>
<span id="cb105-263"><a href="#cb105-263" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb105-264"><a href="#cb105-264" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb105-265"><a href="#cb105-265" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of experiment."</span>,</span>
<span id="cb105-266"><a href="#cb105-266" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-267"><a href="#cb105-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-268"><a href="#cb105-268" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb105-269"><a href="#cb105-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-270"><a href="#cb105-270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Running hello-world pipeline with args"</span>, args)</span>
<span id="cb105-271"><a href="#cb105-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-272"><a href="#cb105-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb105-273"><a href="#cb105-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-274"><a href="#cb105-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-275"><a href="#cb105-275" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-276"><a href="#cb105-276" aria-hidden="true" tabindex="-1"></a><span class="co"># main</span></span>
<span id="cb105-277"><a href="#cb105-277" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-278"><a href="#cb105-278" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main ():</span>
<span id="cb105-279"><a href="#cb105-279" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses arguments and runs pipeline"""</span></span>
<span id="cb105-280"><a href="#cb105-280" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb105-281"><a href="#cb105-281" aria-hidden="true" tabindex="-1"></a>    run_pipeline (</span>
<span id="cb105-282"><a href="#cb105-282" aria-hidden="true" tabindex="-1"></a>        args.config_path,</span>
<span id="cb105-283"><a href="#cb105-283" aria-hidden="true" tabindex="-1"></a>        args.experiment_name,</span>
<span id="cb105-284"><a href="#cb105-284" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb105-285"><a href="#cb105-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-286"><a href="#cb105-286" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-287"><a href="#cb105-287" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb105-288"><a href="#cb105-288" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb105-289"><a href="#cb105-289" aria-hidden="true" tabindex="-1"></a>    main ()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting hello_world_pipeline.py</code></pre>
</div>
</div>
</section>
</section>
<section id="indicating-environment-and-compute-instance" class="level2">
<h2 class="anchored" data-anchor-id="indicating-environment-and-compute-instance">Indicating environment and compute instance</h2>
<p>So far we have been using a serverless compute, where Azure automatically creates the compute instances needed for running the pipeline, scaling and deleting them as required. More information can be found <a href="https://learn.microsoft.com/en-us/azure/machine-learning/how-to-use-serverless-compute?view=azureml-api-2&amp;tabs=python#advantages-of-serverless-compute">here</a>. In this section we opt to use a specific compute instance. This has some advantages: while the serveless mode can shut down our compute when idle, and needs to start it again when new loads arrive, with a compute instance we can ensure that the instance is always running and the functions loaded, which may be important in time critical situations. More information can be found <a href="https://www.techtarget.com/searchcloudcomputing/tip/Top-benefits-and-disadvantages-of-serverless-computing">here</a>.</p>
<p>In addition to this change, we will also us make the code a bit more modular and reusable. We do so by: - Indicating custom environments that can be adapted to different requirements. - Defining different functions that: - Connect to the AML workspace. - Create the environment. - Create the pipeline. - Set up and run the created pipeline.</p>
<p>We will separate the functions into two different files: an <code>aml_utils.py</code> module where we include functions that can be reused across different pipelines, and a <code>hello_world.py</code> script where we have code specific for our “Hello World” pipeline.</p>
<p>Let us start with the <code>aml_utils.py</code> file. We will be writing the consecutive functions one after the other, appending them together with the magic command <code>%%writefile -a aml_utils.py</code>, which appends when we pass the flag <code>-a</code>.</p>
<section id="aml-utils" class="level3">
<h3 class="anchored" data-anchor-id="aml-utils">AML Utils</h3>
<section id="imports" class="level4">
<h4 class="anchored" data-anchor-id="imports">Imports</h4>
<p>We start with the imports:</p>
<div id="a743db69-5312-4389-bb29-2c0b3efb9bac" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile aml_utils.py</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Third-party imports</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> Bunch</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="co"># AML imports</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> MLClient</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml.entities <span class="im">import</span> Environment</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting aml_utils.py</code></pre>
</div>
</div>
</section>
<section id="connecting-to-aml" class="level4">
<h4 class="anchored" data-anchor-id="connecting-to-aml">Connecting to AML</h4>
<p>We encapsulate the code for connecting to AML in a separate function, which we append to the previous code:</p>
<div id="a9aec066-ca9e-428c-9457-eb7ca892c556" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a aml_utils.py</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="ex">connect</span> ():</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Connects to Azure ML workspace and returns a handle to use it."""</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># authenticate</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a handle to the workspace</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    ml_client <span class="op">=</span> MLClient.from_config (</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        credential<span class="op">=</span>credential,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ml_client</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Appending to aml_utils.py</code></pre>
</div>
</div>
</section>
<section id="environment" class="level4">
<h4 class="anchored" data-anchor-id="environment">Environment</h4>
<p>Until now, we have been using <code>environment="AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest"</code> when defining our component interfaces with the <code>command</code> function. This is one of the environments alreadyt available in the Azure ML studio, and it allows us to use scikit-learn as well as azure ml libraries on a ubuntu20.0.04 OS. Let us create a custom environment instead:</p>
<div id="968c1dc0" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world.yml</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>name: hello<span class="op">-</span>world</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>dependencies:</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> python<span class="op">=</span><span class="fl">3.10</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> pip</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> pandas</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> numpy</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> pip:</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> scikit<span class="op">-</span>learn</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> joblib</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> azure<span class="op">-</span>ai<span class="op">-</span>ml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting hello_world.yml</code></pre>
</div>
</div>
<p>Available docker images can be found <a href="https://github.com/Azure/AzureML-Containers?tab=readme-ov-file#featured-tags">here</a>. With this, we can define our envioroment as follows:</p>
<div id="68a58c74-701f-4f96-81c6-d18256a2a81e" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a aml_utils.py</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_env (</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    ml_client,</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    image: <span class="bu">str</span><span class="op">=</span><span class="st">"mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04"</span>,</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    conda_file: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline.yml"</span>,</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    name_env: <span class="bu">str</span><span class="op">=</span><span class="st">"pipeline"</span>,</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    description_env: <span class="bu">str</span><span class="op">=</span><span class="st">"Pipeline environment"</span>,</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Creates environment in AML workspace"</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    env <span class="op">=</span> Environment (</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>image,</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>        conda_file<span class="op">=</span>conda_file,</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>name_env,</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span>description_env,</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>    ml_client.environments.create_or_update (env)</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Appending to aml_utils.py</code></pre>
</div>
</div>
<p>After this, we can replace the name of our environment in the <code>command</code> functions that we will use belowfor defining the interface of each component, for instance as follows:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>preprocessing_component <span class="op">=</span> command(</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span><span class="st">"hello-world@latest"</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="compute-instance" class="level4">
<h4 class="anchored" data-anchor-id="compute-instance">Compute instance</h4>
<p>The compute instance can be indicated with just one line of code, which will be included in the function described in next subsection, called <code>connect_setup_and_run</code>:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># change this with the name of your compute instance in AML</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>pipeline.settings.default_compute <span class="op">=</span> <span class="st">"my-compute-instance"</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will also need to remove the argument <code>compute="serverless"</code> from the pipeline decorator, as we will see below when we define our pipeline function.</p>
</section>
<section id="set-up-and-run-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="set-up-and-run-pipeline">Set up and run pipeline</h4>
<p>We now define a <code>connect_setup_and_run</code> where we put all the necessary code for setting up and running any pipeline previously created. The function also connects to the AML workspace by calling <code>connect</code> above:</p>
<div id="806643d1-11bf-40b6-8c0a-08f95c4be63a" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a aml_utils.py</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_setup_and_run (</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    pipeline_object, </span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    experiment_name: <span class="bu">str</span><span class="op">=</span><span class="st">"pipeline experiment"</span>,</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    compute_name: <span class="bu">str</span><span class="op">=</span><span class="st">"jaumecpu"</span>,</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    image: <span class="bu">str</span><span class="op">=</span><span class="st">"mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04"</span>,</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    conda_file: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline.yml"</span>,</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    name_env: <span class="bu">str</span><span class="op">=</span><span class="st">"pipeline"</span>,</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    description_env: <span class="bu">str</span><span class="op">=</span><span class="st">"Pipeline environment"</span>,</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Does all the setup required to run the pipeline.</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="co">    This includes: connecting, creating environment, indicating our compute instance,</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a><span class="co">    creating and running the pipeline.</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># connect</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>    ml_client <span class="op">=</span> <span class="ex">connect</span> ()</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create env</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>    create_env (</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>        ml_client,</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>image,</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>        conda_file<span class="op">=</span>conda_file,</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>        name_env<span class="op">=</span>name_env,</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>        description_env<span class="op">=</span>description_env,</span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute</span></span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>    pipeline_object.settings.default_compute <span class="op">=</span> compute_name </span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create pipeline and run</span></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a>    pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a>        pipeline_object,</span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project's name</span></span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pipeline running</span></span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>    ml_client.jobs.stream(pipeline_job.name)</span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Appending to aml_utils.py</code></pre>
</div>
</div>
</section>
<section id="read-config-file" class="level4">
<h4 class="anchored" data-anchor-id="read-config-file">Read config file</h4>
<p>Finally, we will write a helper function that reads the configuration from a json file and converts the resulting dictionary into a <code>Bunch</code> object. The <code>Bunch</code> class inherits from the standard dict class, and allows to get access to each dictionary field as if it was an object attribute. It also allows to get access to the dict fields in the standard way. For instance, both:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> my_bunch.my_field</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>my_bunch.my_field <span class="op">=</span> x<span class="op">+</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> my_bunch[<span class="st">"my_field"</span>]</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>my_bunch[<span class="st">"my_field"</span>] <span class="op">=</span> x <span class="op">+</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>are equivalent.</p>
<p>Here is the resulting <code>read_config</code> function:</p>
<div id="f29a3478-b107-43e3-a82c-9aa6f41f954a" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a aml_utils.py</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_config (config_path: <span class="bu">str</span>):</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read config json file</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span> (config_path,<span class="st">"rt"</span>) <span class="im">as</span> config_file:</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> json.load (config_file)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> Bunch (<span class="op">**</span>config)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Appending to aml_utils.py</code></pre>
</div>
</div>
</section>
</section>
<section id="config-file" class="level3">
<h3 class="anchored" data-anchor-id="config-file">Config file</h3>
<p>In this section, we use a config file that is the same as the one in the previous section (“Putting everything into a script”), but adding the following parameters:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>    <span class="er">"compute_name":</span> <span class="er">"jaumecpu",</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">"image"</span> <span class="er">=</span> <span class="er">"mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04",</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    <span class="er">"conda_file"="./hello_world.yml",</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">"description_env"="Hello</span> <span class="er">World"</span>   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The added parameters indicate the compute instance and environment details. The final config file is as follows:</p>
<div id="b8cf07f0-8a96-47de-a808-df66144288c6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile pipeline_input.json</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_training_input_file"</span>: <span class="st">"./data/dummy_input.csv"</span>,</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_training_output_filename"</span>:<span class="st">"preprocessed_training_data.csv"</span>,</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"x"</span>: <span class="dv">10</span>,</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_test_input_file"</span>: <span class="st">"./data/dummy_test.csv"</span>,</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"preprocessing_test_output_filename"</span>: <span class="st">"preprocessed_test_data.csv"</span>,</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"training_output_filename"</span>: <span class="st">"model.pk"</span>,</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"inference_output_filename"</span>: <span class="st">"inference_results.csv"</span>,</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"experiment_name"</span>: <span class="st">"e2e_three_components_in_script"</span>,</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"compute_name"</span>: <span class="st">"jaumecpu"</span>,</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"image"</span>: <span class="st">"mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04"</span>,</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conda_file"</span>: <span class="st">"./hello_world.yml"</span>,</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name_env"</span>: <span class="st">"hello-world"</span>,</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description_env"</span>: <span class="st">"Hello World"</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting pipeline_input.json</code></pre>
</div>
</div>
</section>
<section id="pipeline-script-1" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-script-1">Pipeline script</h3>
<p>Let us know write the functions that are specific for our current pipeline. We do so in the script that we will be running from command line, <code>hello_world_pipeline.py</code>.</p>
<section id="imports-1" class="level4">
<h4 class="anchored" data-anchor-id="imports-1">Imports</h4>
<p>Let us start again with the imports section:</p>
<div id="19d524ee-98f0-4dcb-b3c7-f306a805fe47" class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world_pipeline.py</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="co"># AML imports</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> (</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>    command,</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    dsl,</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>    Input,</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    Output,</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Utility functions</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aml_utils <span class="im">import</span> (</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">connect</span>,</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>    create_env,</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>    connect_setup_and_run,</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>    read_config,</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pipeline-function" class="level4">
<h4 class="anchored" data-anchor-id="pipeline-function">Pipeline function</h4>
<p>We write next our pipeline function, which indicates the components to be used and how they are connected throug inputs and outputs. The only change with respect to previous pipeline functions is that we indicate as environment the one we just created, “hello-world”, when we describe each component through the <code>command</code> function. The rest doesn’t change.</p>
<div id="2ddc3356-1888-4c51-8708-552679a3021c" class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a hello_world_pipeline.py</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="at">@dsl.pipeline</span>(</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> three_components_pipeline(</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, first component:</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_input_file: <span class="bu">str</span>,</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_output_filename: <span class="bu">str</span>,</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">int</span>,</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing component parameters, second component:</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_input_file: <span class="bu">str</span>,</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_output_filename: <span class="bu">str</span>,</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component parameters:</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>    training_output_filename: <span class="bu">str</span>, </span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference component parameters:</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>    inference_output_filename: <span class="bu">str</span>,</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Third pipeline: preprocessing, training and inference.</span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_input_file: str</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing training data to be preprocessed.</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_training_output_filename: str</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, training data.</span></span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a><span class="co">    x: int</span></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Number to add to input data for preprocessing it.</span></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_input_file: str</span></span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to file containing test data to be preprocessed.</span></span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a><span class="co">    preprocessing_test_output_filename: str</span></span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the preprocessed, test data.</span></span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a><span class="co">    training_output_filename: str</span></span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the trained model.</span></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a><span class="co">    inference_output_filename: str</span></span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a><span class="co">        Name of file containing the output data with inference results.</span></span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing</span></span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interface</span></span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a>    preprocessing_component <span class="op">=</span> command(</span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a>            input_file<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a>            output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a>        command<span class="op">=</span><span class="st">"python preprocessing.py "</span></span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input_file $</span><span class="sc">{{</span><span class="st">inputs.input_file</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">"-x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a>        environment<span class="op">=</span><span class="st">"hello-world@latest"</span>,</span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a>        display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-65"><a href="#cb127-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiation</span></span>
<span id="cb127-66"><a href="#cb127-66" aria-hidden="true" tabindex="-1"></a>    preprocessing_training_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb127-67"><a href="#cb127-67" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_training_input_file,</span>
<span id="cb127-68"><a href="#cb127-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb127-69"><a href="#cb127-69" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb127-70"><a href="#cb127-70" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb127-71"><a href="#cb127-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-72"><a href="#cb127-72" aria-hidden="true" tabindex="-1"></a>    preprocessing_test_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb127-73"><a href="#cb127-73" aria-hidden="true" tabindex="-1"></a>        input_file<span class="op">=</span>preprocessing_test_input_file,</span>
<span id="cb127-74"><a href="#cb127-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb127-75"><a href="#cb127-75" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb127-76"><a href="#cb127-76" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb127-77"><a href="#cb127-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-78"><a href="#cb127-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-79"><a href="#cb127-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb127-80"><a href="#cb127-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training component</span></span>
<span id="cb127-81"><a href="#cb127-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb127-82"><a href="#cb127-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interface</span></span>
<span id="cb127-83"><a href="#cb127-83" aria-hidden="true" tabindex="-1"></a>    training_component <span class="op">=</span> command(</span>
<span id="cb127-84"><a href="#cb127-84" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb127-85"><a href="#cb127-85" aria-hidden="true" tabindex="-1"></a>            input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb127-86"><a href="#cb127-86" aria-hidden="true" tabindex="-1"></a>            input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb127-87"><a href="#cb127-87" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb127-88"><a href="#cb127-88" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb127-89"><a href="#cb127-89" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb127-90"><a href="#cb127-90" aria-hidden="true" tabindex="-1"></a>            output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb127-91"><a href="#cb127-91" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb127-92"><a href="#cb127-92" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb127-93"><a href="#cb127-93" aria-hidden="true" tabindex="-1"></a>        command<span class="op">=</span><span class="st">"python training.py "</span></span>
<span id="cb127-94"><a href="#cb127-94" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input_folder $</span><span class="sc">{{</span><span class="st">inputs.input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-95"><a href="#cb127-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input_filename $</span><span class="sc">{{</span><span class="st">inputs.input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-96"><a href="#cb127-96" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-97"><a href="#cb127-97" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb127-98"><a href="#cb127-98" aria-hidden="true" tabindex="-1"></a>        environment<span class="op">=</span><span class="st">"hello-world@latest"</span>,</span>
<span id="cb127-99"><a href="#cb127-99" aria-hidden="true" tabindex="-1"></a>        display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb127-100"><a href="#cb127-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-101"><a href="#cb127-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-102"><a href="#cb127-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiation</span></span>
<span id="cb127-103"><a href="#cb127-103" aria-hidden="true" tabindex="-1"></a>    training_job <span class="op">=</span> training_component(</span>
<span id="cb127-104"><a href="#cb127-104" aria-hidden="true" tabindex="-1"></a>        input_folder<span class="op">=</span>preprocessing_training_job.outputs.output_folder,</span>
<span id="cb127-105"><a href="#cb127-105" aria-hidden="true" tabindex="-1"></a>        input_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb127-106"><a href="#cb127-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb127-107"><a href="#cb127-107" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb127-108"><a href="#cb127-108" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-109"><a href="#cb127-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-110"><a href="#cb127-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb127-111"><a href="#cb127-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference</span></span>
<span id="cb127-112"><a href="#cb127-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb127-113"><a href="#cb127-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interface</span></span>
<span id="cb127-114"><a href="#cb127-114" aria-hidden="true" tabindex="-1"></a>    inference_component <span class="op">=</span> command(</span>
<span id="cb127-115"><a href="#cb127-115" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb127-116"><a href="#cb127-116" aria-hidden="true" tabindex="-1"></a>            preprocessed_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb127-117"><a href="#cb127-117" aria-hidden="true" tabindex="-1"></a>            preprocessed_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb127-118"><a href="#cb127-118" aria-hidden="true" tabindex="-1"></a>            model_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb127-119"><a href="#cb127-119" aria-hidden="true" tabindex="-1"></a>            model_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb127-120"><a href="#cb127-120" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb127-121"><a href="#cb127-121" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb127-122"><a href="#cb127-122" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb127-123"><a href="#cb127-123" aria-hidden="true" tabindex="-1"></a>            output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb127-124"><a href="#cb127-124" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb127-125"><a href="#cb127-125" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"./inference/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb127-126"><a href="#cb127-126" aria-hidden="true" tabindex="-1"></a>        command<span class="op">=</span><span class="st">"python inference.py "</span> </span>
<span id="cb127-127"><a href="#cb127-127" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--preprocessed_input_folder $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-128"><a href="#cb127-128" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--preprocessed_input_filename $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-129"><a href="#cb127-129" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--model_input_folder $</span><span class="sc">{{</span><span class="st">inputs.model_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-130"><a href="#cb127-130" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--model_input_filename $</span><span class="sc">{{</span><span class="st">inputs.model_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-131"><a href="#cb127-131" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb127-132"><a href="#cb127-132" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st"> "</span>,</span>
<span id="cb127-133"><a href="#cb127-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-134"><a href="#cb127-134" aria-hidden="true" tabindex="-1"></a>        environment<span class="op">=</span><span class="st">"hello-world@latest"</span>,</span>
<span id="cb127-135"><a href="#cb127-135" aria-hidden="true" tabindex="-1"></a>        display_name<span class="op">=</span><span class="st">"inference"</span>,</span>
<span id="cb127-136"><a href="#cb127-136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-137"><a href="#cb127-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-138"><a href="#cb127-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiation</span></span>
<span id="cb127-139"><a href="#cb127-139" aria-hidden="true" tabindex="-1"></a>    inference_job <span class="op">=</span> inference_component(</span>
<span id="cb127-140"><a href="#cb127-140" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_folder<span class="op">=</span>preprocessing_test_job.outputs.output_folder,</span>
<span id="cb127-141"><a href="#cb127-141" aria-hidden="true" tabindex="-1"></a>        preprocessed_input_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb127-142"><a href="#cb127-142" aria-hidden="true" tabindex="-1"></a>        model_input_folder<span class="op">=</span>training_job.outputs.output_folder,</span>
<span id="cb127-143"><a href="#cb127-143" aria-hidden="true" tabindex="-1"></a>        model_input_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb127-144"><a href="#cb127-144" aria-hidden="true" tabindex="-1"></a>        <span class="co">#output_folder: automatically determined</span></span>
<span id="cb127-145"><a href="#cb127-145" aria-hidden="true" tabindex="-1"></a>        output_filename<span class="op">=</span>inference_output_filename,</span>
<span id="cb127-146"><a href="#cb127-146" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb127-147"><a href="#cb127-147" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-and-run-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="create-and-run-pipeline">Create and run pipeline</h4>
<p>Next we define a function that both creates and runs the pipeline implemented above. This function performs all the steps implemented so far: it reads a config file, instantiates a pipeline object by calling our <code>three_components_pipeline</code> function, and finally performs the pipeline set-up and runs it by calling <code>connect_setup_and_run</code>:</p>
<div id="ce64c95d-979a-4293-85d4-7c1dd1d2e24f" class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a hello_world_pipeline.py</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_pipeline (</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    config_path: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline_input.json"</span>,</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read config</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> read_config (config_path)</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build pipeline </span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline_object <span class="op">=</span> three_components_pipeline(</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># first preprocessing component</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_training_input_file),</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_output_filename<span class="op">=</span>config.preprocessing_training_output_filename,</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>config.x,</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># second preprocessing component</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_test_input_file),</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_output_filename<span class="op">=</span>config.preprocessing_test_output_filename,</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training component parameters:</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>        training_output_filename<span class="op">=</span>config.training_output_filename,</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Inference component parameters:</span></span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>        inference_output_filename<span class="op">=</span>config.inference_output_filename,</span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># name env:</span></span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>        name_env<span class="op">=</span>config.name_env,</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>    connect_setup_and_run (</span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>        three_components_pipeline_object, </span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a>        compute_name<span class="op">=</span>config.compute_name,</span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>config.image,</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>        conda_file<span class="op">=</span>config.conda_file,</span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>        name_env<span class="op">=</span>config.name_env,</span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>        description_env<span class="op">=</span>config.description_env,</span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting hello_world_pipeline.py</code></pre>
</div>
</div>
</section>
<section id="parsing-arguments" class="level4">
<h4 class="anchored" data-anchor-id="parsing-arguments">Parsing arguments</h4>
<p>Next, we define a function for parsing the command line arguments:</p>
<div id="895da1f5-3599-4157-a77c-854453e244ef" class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a hello_world_pipeline.py</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--config-path"</span>, </span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"pipeline_input.json"</span>,</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Path to config file specifying pipeline input parameters."</span>,</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--experiment-name"</span>, </span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of experiment."</span>,</span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Running hello-world pipeline with args"</span>, args)</span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-section" class="level4">
<h4 class="anchored" data-anchor-id="main-section">Main section</h4>
<p>And finally, we write our main function which simply calls the argument parser and calls <code>run_pipeline</code> with the parsed arguments:</p>
<div id="6ca9ab74-0b06-48d6-879d-a58e0aaacaf8" class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="op">-</span>a hello_world_pipeline.py</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main ():</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses arguments and runs pipeline"""</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    run_pipeline (</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>        args.config_path,</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>        args.experiment_name,</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    main ()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is how the pipeline can be run from ipython, and similarly from the command line:</p>
<div id="2184344d-dd29-42fc-8c34-6ab70e54f869" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>run hello_world_pipeline.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found the config file in: /config.json
Class AutoDeleteSettingSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class AutoDeleteConditionSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class BaseAutoDeleteSettingSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class IntellectualPropertySchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class ProtectionLevelSchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.
Class BaseIntellectualPropertySchema: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running hello-world pipeline with args Namespace(config_path='pipeline_input.json', experiment_name='hello-world-experiment')
RunId: good_brain_fqtwt959vf
Web View: https://ml.azure.com/runs/good_brain_fqtwt959vf?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-04-10 09:06:04Z] Submitting 2 runs, first five are: 56673d93:0ab3c91a-266e-42d1-964b-af6cd9a5a8a9,9dc0f6c7:2a6af947-815b-4014-951e-0a66d370a79b
[2024-04-10 09:07:08Z] Completing processing run id 0ab3c91a-266e-42d1-964b-af6cd9a5a8a9.
[2024-04-10 09:07:08Z] Completing processing run id 2a6af947-815b-4014-951e-0a66d370a79b.
[2024-04-10 09:07:08Z] Submitting 1 runs, first five are: 20670901:7fc64bfc-bee0-4238-be3d-fbd26f2304b6
[2024-04-10 09:07:30Z] Completing processing run id 7fc64bfc-bee0-4238-be3d-fbd26f2304b6.
[2024-04-10 09:07:30Z] Submitting 1 runs, first five are: 11635808:7d181008-9749-4ba0-8af0-ee22a9a90a1f
[2024-04-10 09:07:52Z] Completing processing run id 7d181008-9749-4ba0-8af0-ee22a9a90a1f.

Execution Summary
=================
RunId: good_brain_fqtwt959vf
Web View: https://ml.azure.com/runs/good_brain_fqtwt959vf?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="with-closure" class="level2">
<h2 class="anchored" data-anchor-id="with-closure">With closure</h2>
<p>We add the following to our config file:</p>
<pre><code>    "name_env"="hello-world",</code></pre>
<div id="c22f8da7-4f35-465f-9c8e-1fe134ddb236" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hello_world_pipeline.py</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Imports</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Third-party imports</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> Bunch</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a><span class="co"># AML imports</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml <span class="im">import</span> (</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>    command,</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>    dsl,</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>    Input,</span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>    Output,</span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>    MLClient</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.ai.ml.entities <span class="im">import</span> Environment</span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Connection</span></span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="ex">connect</span> ():</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># authenticate</span></span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>    credential <span class="op">=</span> DefaultAzureCredential()</span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a handle to the workspace</span></span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>    ml_client <span class="op">=</span> MLClient.from_config (</span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>        credential<span class="op">=</span>credential,</span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ml_client</span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a><span class="co"># environment</span></span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-41"><a href="#cb136-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_env (</span>
<span id="cb136-42"><a href="#cb136-42" aria-hidden="true" tabindex="-1"></a>    ml_client,</span>
<span id="cb136-43"><a href="#cb136-43" aria-hidden="true" tabindex="-1"></a>    image: <span class="bu">str</span><span class="op">=</span><span class="st">"mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04"</span>,</span>
<span id="cb136-44"><a href="#cb136-44" aria-hidden="true" tabindex="-1"></a>    conda_file: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline.yml"</span>,</span>
<span id="cb136-45"><a href="#cb136-45" aria-hidden="true" tabindex="-1"></a>    name_env: <span class="bu">str</span><span class="op">=</span><span class="st">"pipeline"</span>,</span>
<span id="cb136-46"><a href="#cb136-46" aria-hidden="true" tabindex="-1"></a>    description_env: <span class="bu">str</span><span class="op">=</span><span class="st">"Pipeline environment"</span>,</span>
<span id="cb136-47"><a href="#cb136-47" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb136-48"><a href="#cb136-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Creates environment in AML workspace"</span></span>
<span id="cb136-49"><a href="#cb136-49" aria-hidden="true" tabindex="-1"></a>    env <span class="op">=</span> Environment (</span>
<span id="cb136-50"><a href="#cb136-50" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>image,</span>
<span id="cb136-51"><a href="#cb136-51" aria-hidden="true" tabindex="-1"></a>        conda_file<span class="op">=</span>conda_file,</span>
<span id="cb136-52"><a href="#cb136-52" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>name_env,</span>
<span id="cb136-53"><a href="#cb136-53" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span>description_env,</span>
<span id="cb136-54"><a href="#cb136-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-55"><a href="#cb136-55" aria-hidden="true" tabindex="-1"></a>    ml_client.environments.create_or_update (env)</span>
<span id="cb136-56"><a href="#cb136-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-57"><a href="#cb136-57" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-58"><a href="#cb136-58" aria-hidden="true" tabindex="-1"></a><span class="co"># connect and setup</span></span>
<span id="cb136-59"><a href="#cb136-59" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-60"><a href="#cb136-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_setup_and_run (</span>
<span id="cb136-61"><a href="#cb136-61" aria-hidden="true" tabindex="-1"></a>    pipeline_object, </span>
<span id="cb136-62"><a href="#cb136-62" aria-hidden="true" tabindex="-1"></a>    experiment_name: <span class="bu">str</span><span class="op">=</span><span class="st">"pipeline experiment"</span>,</span>
<span id="cb136-63"><a href="#cb136-63" aria-hidden="true" tabindex="-1"></a>    compute_name: <span class="bu">str</span><span class="op">=</span><span class="st">"jaumecpu"</span>,</span>
<span id="cb136-64"><a href="#cb136-64" aria-hidden="true" tabindex="-1"></a>    image: <span class="bu">str</span><span class="op">=</span><span class="st">"mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04"</span>,</span>
<span id="cb136-65"><a href="#cb136-65" aria-hidden="true" tabindex="-1"></a>    conda_file: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline.yml"</span>,</span>
<span id="cb136-66"><a href="#cb136-66" aria-hidden="true" tabindex="-1"></a>    name_env: <span class="bu">str</span><span class="op">=</span><span class="st">"pipeline"</span>,</span>
<span id="cb136-67"><a href="#cb136-67" aria-hidden="true" tabindex="-1"></a>    description_env: <span class="bu">str</span><span class="op">=</span><span class="st">"Pipeline environment"</span>,</span>
<span id="cb136-68"><a href="#cb136-68" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb136-69"><a href="#cb136-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Does all the setup required to run the pipeline.</span></span>
<span id="cb136-70"><a href="#cb136-70" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb136-71"><a href="#cb136-71" aria-hidden="true" tabindex="-1"></a><span class="co">    This includes: connecting, creating environment, indicating our compute instance,</span></span>
<span id="cb136-72"><a href="#cb136-72" aria-hidden="true" tabindex="-1"></a><span class="co">    creating and running the pipeline.</span></span>
<span id="cb136-73"><a href="#cb136-73" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb136-74"><a href="#cb136-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># connect</span></span>
<span id="cb136-75"><a href="#cb136-75" aria-hidden="true" tabindex="-1"></a>    ml_client <span class="op">=</span> <span class="ex">connect</span> ()</span>
<span id="cb136-76"><a href="#cb136-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-77"><a href="#cb136-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create env</span></span>
<span id="cb136-78"><a href="#cb136-78" aria-hidden="true" tabindex="-1"></a>    create_env (</span>
<span id="cb136-79"><a href="#cb136-79" aria-hidden="true" tabindex="-1"></a>        ml_client,</span>
<span id="cb136-80"><a href="#cb136-80" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>image,</span>
<span id="cb136-81"><a href="#cb136-81" aria-hidden="true" tabindex="-1"></a>        conda_file<span class="op">=</span>conda_file,</span>
<span id="cb136-82"><a href="#cb136-82" aria-hidden="true" tabindex="-1"></a>        name_env<span class="op">=</span>name_env,</span>
<span id="cb136-83"><a href="#cb136-83" aria-hidden="true" tabindex="-1"></a>        description_env<span class="op">=</span>description_env,</span>
<span id="cb136-84"><a href="#cb136-84" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-85"><a href="#cb136-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-86"><a href="#cb136-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute</span></span>
<span id="cb136-87"><a href="#cb136-87" aria-hidden="true" tabindex="-1"></a>    pipeline_object.settings.default_compute <span class="op">=</span> compute_name </span>
<span id="cb136-88"><a href="#cb136-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-89"><a href="#cb136-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create pipeline and run</span></span>
<span id="cb136-90"><a href="#cb136-90" aria-hidden="true" tabindex="-1"></a>    pipeline_job <span class="op">=</span> ml_client.jobs.create_or_update(</span>
<span id="cb136-91"><a href="#cb136-91" aria-hidden="true" tabindex="-1"></a>        pipeline_object,</span>
<span id="cb136-92"><a href="#cb136-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project's name</span></span>
<span id="cb136-93"><a href="#cb136-93" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb136-94"><a href="#cb136-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-95"><a href="#cb136-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-96"><a href="#cb136-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb136-97"><a href="#cb136-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pipeline running</span></span>
<span id="cb136-98"><a href="#cb136-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------</span></span>
<span id="cb136-99"><a href="#cb136-99" aria-hidden="true" tabindex="-1"></a>    ml_client.jobs.stream(pipeline_job.name)</span>
<span id="cb136-100"><a href="#cb136-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-101"><a href="#cb136-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_config (config_path: <span class="bu">str</span>):</span>
<span id="cb136-102"><a href="#cb136-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read config json file</span></span>
<span id="cb136-103"><a href="#cb136-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span> (config_path,<span class="st">"rt"</span>) <span class="im">as</span> config_file:</span>
<span id="cb136-104"><a href="#cb136-104" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> json.load (config_file)</span>
<span id="cb136-105"><a href="#cb136-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-106"><a href="#cb136-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert config dictionary into a Bunch object.</span></span>
<span id="cb136-107"><a href="#cb136-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This allows to get access to fields as object attributes</span></span>
<span id="cb136-108"><a href="#cb136-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Which I find more convenient.</span></span>
<span id="cb136-109"><a href="#cb136-109" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> Bunch (<span class="op">**</span>config)</span>
<span id="cb136-110"><a href="#cb136-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-111"><a href="#cb136-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> config</span>
<span id="cb136-112"><a href="#cb136-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-113"><a href="#cb136-113" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-114"><a href="#cb136-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline running</span></span>
<span id="cb136-115"><a href="#cb136-115" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-116"><a href="#cb136-116" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_pipeline (</span>
<span id="cb136-117"><a href="#cb136-117" aria-hidden="true" tabindex="-1"></a>    config_path: <span class="bu">str</span><span class="op">=</span><span class="st">"./pipeline_input.json"</span>,</span>
<span id="cb136-118"><a href="#cb136-118" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb136-119"><a href="#cb136-119" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb136-120"><a href="#cb136-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read config</span></span>
<span id="cb136-121"><a href="#cb136-121" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> read_config (config_path)</span>
<span id="cb136-122"><a href="#cb136-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb136-123"><a href="#cb136-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pipeline definition</span></span>
<span id="cb136-124"><a href="#cb136-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">@dsl.pipeline</span>(</span>
<span id="cb136-125"><a href="#cb136-125" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"E2E hello world pipeline with input"</span>,</span>
<span id="cb136-126"><a href="#cb136-126" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-127"><a href="#cb136-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> three_components_pipeline(</span>
<span id="cb136-128"><a href="#cb136-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Preprocessing component parameters, first component:</span></span>
<span id="cb136-129"><a href="#cb136-129" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_input_file: <span class="bu">str</span>,</span>
<span id="cb136-130"><a href="#cb136-130" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_output_filename: <span class="bu">str</span>,</span>
<span id="cb136-131"><a href="#cb136-131" aria-hidden="true" tabindex="-1"></a>        x: <span class="bu">int</span>,</span>
<span id="cb136-132"><a href="#cb136-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-133"><a href="#cb136-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Preprocessing component parameters, second component:</span></span>
<span id="cb136-134"><a href="#cb136-134" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_input_file: <span class="bu">str</span>,</span>
<span id="cb136-135"><a href="#cb136-135" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_output_filename: <span class="bu">str</span>,</span>
<span id="cb136-136"><a href="#cb136-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-137"><a href="#cb136-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training component parameters:</span></span>
<span id="cb136-138"><a href="#cb136-138" aria-hidden="true" tabindex="-1"></a>        training_output_filename: <span class="bu">str</span>, </span>
<span id="cb136-139"><a href="#cb136-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-140"><a href="#cb136-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Inference component parameters:</span></span>
<span id="cb136-141"><a href="#cb136-141" aria-hidden="true" tabindex="-1"></a>        inference_output_filename: <span class="bu">str</span>,</span>
<span id="cb136-142"><a href="#cb136-142" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb136-143"><a href="#cb136-143" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb136-144"><a href="#cb136-144" aria-hidden="true" tabindex="-1"></a><span class="co">        Third pipeline: preprocessing, training and inference.</span></span>
<span id="cb136-145"><a href="#cb136-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-146"><a href="#cb136-146" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb136-147"><a href="#cb136-147" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb136-148"><a href="#cb136-148" aria-hidden="true" tabindex="-1"></a><span class="co">        preprocessing_training_input_file: str</span></span>
<span id="cb136-149"><a href="#cb136-149" aria-hidden="true" tabindex="-1"></a><span class="co">            Path to file containing training data to be preprocessed.</span></span>
<span id="cb136-150"><a href="#cb136-150" aria-hidden="true" tabindex="-1"></a><span class="co">        preprocessing_training_output_filename: str</span></span>
<span id="cb136-151"><a href="#cb136-151" aria-hidden="true" tabindex="-1"></a><span class="co">            Name of file containing the preprocessed, training data.</span></span>
<span id="cb136-152"><a href="#cb136-152" aria-hidden="true" tabindex="-1"></a><span class="co">        x: int</span></span>
<span id="cb136-153"><a href="#cb136-153" aria-hidden="true" tabindex="-1"></a><span class="co">            Number to add to input data for preprocessing it.</span></span>
<span id="cb136-154"><a href="#cb136-154" aria-hidden="true" tabindex="-1"></a><span class="co">        preprocessing_test_input_file: str</span></span>
<span id="cb136-155"><a href="#cb136-155" aria-hidden="true" tabindex="-1"></a><span class="co">            Path to file containing test data to be preprocessed.</span></span>
<span id="cb136-156"><a href="#cb136-156" aria-hidden="true" tabindex="-1"></a><span class="co">        preprocessing_test_output_filename: str</span></span>
<span id="cb136-157"><a href="#cb136-157" aria-hidden="true" tabindex="-1"></a><span class="co">            Name of file containing the preprocessed, test data.</span></span>
<span id="cb136-158"><a href="#cb136-158" aria-hidden="true" tabindex="-1"></a><span class="co">        training_output_filename: str</span></span>
<span id="cb136-159"><a href="#cb136-159" aria-hidden="true" tabindex="-1"></a><span class="co">            Name of file containing the trained model.</span></span>
<span id="cb136-160"><a href="#cb136-160" aria-hidden="true" tabindex="-1"></a><span class="co">        inference_output_filename: str</span></span>
<span id="cb136-161"><a href="#cb136-161" aria-hidden="true" tabindex="-1"></a><span class="co">            Name of file containing the output data with inference results.</span></span>
<span id="cb136-162"><a href="#cb136-162" aria-hidden="true" tabindex="-1"></a><span class="co">        name_env: str</span></span>
<span id="cb136-163"><a href="#cb136-163" aria-hidden="true" tabindex="-1"></a><span class="co">            Name of environment to use.</span></span>
<span id="cb136-164"><a href="#cb136-164" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb136-165"><a href="#cb136-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-166"><a href="#cb136-166" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="ss">f"using </span><span class="sc">{</span>config<span class="sc">.</span>name_env<span class="sc">}</span><span class="ss">@latest"</span>)</span>
<span id="cb136-167"><a href="#cb136-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb136-168"><a href="#cb136-168" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-169"><a href="#cb136-169" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Preprocessing</span></span>
<span id="cb136-170"><a href="#cb136-170" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-171"><a href="#cb136-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interface</span></span>
<span id="cb136-172"><a href="#cb136-172" aria-hidden="true" tabindex="-1"></a>        preprocessing_component <span class="op">=</span> command(</span>
<span id="cb136-173"><a href="#cb136-173" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb136-174"><a href="#cb136-174" aria-hidden="true" tabindex="-1"></a>                input_file<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>),</span>
<span id="cb136-175"><a href="#cb136-175" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"number"</span>),</span>
<span id="cb136-176"><a href="#cb136-176" aria-hidden="true" tabindex="-1"></a>                output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb136-177"><a href="#cb136-177" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb136-178"><a href="#cb136-178" aria-hidden="true" tabindex="-1"></a>            outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb136-179"><a href="#cb136-179" aria-hidden="true" tabindex="-1"></a>                output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb136-180"><a href="#cb136-180" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb136-181"><a href="#cb136-181" aria-hidden="true" tabindex="-1"></a>            code<span class="op">=</span><span class="ss">f"./preprocessing/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb136-182"><a href="#cb136-182" aria-hidden="true" tabindex="-1"></a>            command<span class="op">=</span><span class="st">"python preprocessing.py "</span></span>
<span id="cb136-183"><a href="#cb136-183" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--input_file $</span><span class="sc">{{</span><span class="st">inputs.input_file</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-184"><a href="#cb136-184" aria-hidden="true" tabindex="-1"></a>                <span class="st">"-x $</span><span class="sc">{{</span><span class="st">inputs.x</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-185"><a href="#cb136-185" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-186"><a href="#cb136-186" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb136-187"><a href="#cb136-187" aria-hidden="true" tabindex="-1"></a>            environment<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>config<span class="sc">.</span>name_env<span class="sc">}</span><span class="ss">@latest"</span>,</span>
<span id="cb136-188"><a href="#cb136-188" aria-hidden="true" tabindex="-1"></a>            display_name<span class="op">=</span><span class="st">"Pre-processing"</span>,</span>
<span id="cb136-189"><a href="#cb136-189" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-190"><a href="#cb136-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-191"><a href="#cb136-191" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instantiation</span></span>
<span id="cb136-192"><a href="#cb136-192" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb136-193"><a href="#cb136-193" aria-hidden="true" tabindex="-1"></a>            input_file<span class="op">=</span>preprocessing_training_input_file,</span>
<span id="cb136-194"><a href="#cb136-194" aria-hidden="true" tabindex="-1"></a>            <span class="co">#output_folder: automatically determined</span></span>
<span id="cb136-195"><a href="#cb136-195" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb136-196"><a href="#cb136-196" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>x,</span>
<span id="cb136-197"><a href="#cb136-197" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-198"><a href="#cb136-198" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_job <span class="op">=</span> preprocessing_component(</span>
<span id="cb136-199"><a href="#cb136-199" aria-hidden="true" tabindex="-1"></a>            input_file<span class="op">=</span>preprocessing_test_input_file,</span>
<span id="cb136-200"><a href="#cb136-200" aria-hidden="true" tabindex="-1"></a>            <span class="co">#output_folder: automatically determined</span></span>
<span id="cb136-201"><a href="#cb136-201" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb136-202"><a href="#cb136-202" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>x,</span>
<span id="cb136-203"><a href="#cb136-203" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-204"><a href="#cb136-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-205"><a href="#cb136-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-206"><a href="#cb136-206" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training component</span></span>
<span id="cb136-207"><a href="#cb136-207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-208"><a href="#cb136-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interface</span></span>
<span id="cb136-209"><a href="#cb136-209" aria-hidden="true" tabindex="-1"></a>        training_component <span class="op">=</span> command(</span>
<span id="cb136-210"><a href="#cb136-210" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb136-211"><a href="#cb136-211" aria-hidden="true" tabindex="-1"></a>                input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb136-212"><a href="#cb136-212" aria-hidden="true" tabindex="-1"></a>                input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb136-213"><a href="#cb136-213" aria-hidden="true" tabindex="-1"></a>                output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb136-214"><a href="#cb136-214" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb136-215"><a href="#cb136-215" aria-hidden="true" tabindex="-1"></a>            outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb136-216"><a href="#cb136-216" aria-hidden="true" tabindex="-1"></a>                output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb136-217"><a href="#cb136-217" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb136-218"><a href="#cb136-218" aria-hidden="true" tabindex="-1"></a>            code<span class="op">=</span><span class="ss">f"./training/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb136-219"><a href="#cb136-219" aria-hidden="true" tabindex="-1"></a>            command<span class="op">=</span><span class="st">"python training.py "</span></span>
<span id="cb136-220"><a href="#cb136-220" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--input_folder $</span><span class="sc">{{</span><span class="st">inputs.input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-221"><a href="#cb136-221" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--input_filename $</span><span class="sc">{{</span><span class="st">inputs.input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-222"><a href="#cb136-222" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-223"><a href="#cb136-223" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st">"</span>,</span>
<span id="cb136-224"><a href="#cb136-224" aria-hidden="true" tabindex="-1"></a>            environment<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>config<span class="sc">.</span>name_env<span class="sc">}</span><span class="ss">@latest"</span>,</span>
<span id="cb136-225"><a href="#cb136-225" aria-hidden="true" tabindex="-1"></a>            display_name<span class="op">=</span><span class="st">"Training"</span>,</span>
<span id="cb136-226"><a href="#cb136-226" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-227"><a href="#cb136-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-228"><a href="#cb136-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instantiation</span></span>
<span id="cb136-229"><a href="#cb136-229" aria-hidden="true" tabindex="-1"></a>        training_job <span class="op">=</span> training_component(</span>
<span id="cb136-230"><a href="#cb136-230" aria-hidden="true" tabindex="-1"></a>            input_folder<span class="op">=</span>preprocessing_training_job.outputs.output_folder,</span>
<span id="cb136-231"><a href="#cb136-231" aria-hidden="true" tabindex="-1"></a>            input_filename<span class="op">=</span>preprocessing_training_output_filename,</span>
<span id="cb136-232"><a href="#cb136-232" aria-hidden="true" tabindex="-1"></a>            <span class="co">#output_folder: automatically determined</span></span>
<span id="cb136-233"><a href="#cb136-233" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb136-234"><a href="#cb136-234" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-235"><a href="#cb136-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-236"><a href="#cb136-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-237"><a href="#cb136-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Inference</span></span>
<span id="cb136-238"><a href="#cb136-238" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-239"><a href="#cb136-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interface</span></span>
<span id="cb136-240"><a href="#cb136-240" aria-hidden="true" tabindex="-1"></a>        inference_component <span class="op">=</span> command(</span>
<span id="cb136-241"><a href="#cb136-241" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb136-242"><a href="#cb136-242" aria-hidden="true" tabindex="-1"></a>                preprocessed_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb136-243"><a href="#cb136-243" aria-hidden="true" tabindex="-1"></a>                preprocessed_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb136-244"><a href="#cb136-244" aria-hidden="true" tabindex="-1"></a>                model_input_folder<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb136-245"><a href="#cb136-245" aria-hidden="true" tabindex="-1"></a>                model_input_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb136-246"><a href="#cb136-246" aria-hidden="true" tabindex="-1"></a>                output_filename<span class="op">=</span>Input (<span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>),</span>
<span id="cb136-247"><a href="#cb136-247" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb136-248"><a href="#cb136-248" aria-hidden="true" tabindex="-1"></a>            outputs<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb136-249"><a href="#cb136-249" aria-hidden="true" tabindex="-1"></a>                output_folder<span class="op">=</span>Output (<span class="bu">type</span><span class="op">=</span><span class="st">"uri_folder"</span>),</span>
<span id="cb136-250"><a href="#cb136-250" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb136-251"><a href="#cb136-251" aria-hidden="true" tabindex="-1"></a>            code<span class="op">=</span><span class="ss">f"./inference/"</span>,  <span class="co"># location of source code: in this case, the root folder</span></span>
<span id="cb136-252"><a href="#cb136-252" aria-hidden="true" tabindex="-1"></a>            command<span class="op">=</span><span class="st">"python inference.py "</span> </span>
<span id="cb136-253"><a href="#cb136-253" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--preprocessed_input_folder $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-254"><a href="#cb136-254" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--preprocessed_input_filename $</span><span class="sc">{{</span><span class="st">inputs.preprocessed_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-255"><a href="#cb136-255" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--model_input_folder $</span><span class="sc">{{</span><span class="st">inputs.model_input_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-256"><a href="#cb136-256" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--model_input_filename $</span><span class="sc">{{</span><span class="st">inputs.model_input_filename</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-257"><a href="#cb136-257" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--output_folder $</span><span class="sc">{{</span><span class="st">outputs.output_folder</span><span class="sc">}}</span><span class="st"> "</span></span>
<span id="cb136-258"><a href="#cb136-258" aria-hidden="true" tabindex="-1"></a>                <span class="st">"--output_filename $</span><span class="sc">{{</span><span class="st">inputs.output_filename</span><span class="sc">}}</span><span class="st"> "</span>,</span>
<span id="cb136-259"><a href="#cb136-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-260"><a href="#cb136-260" aria-hidden="true" tabindex="-1"></a>            environment<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>config<span class="sc">.</span>name_env<span class="sc">}</span><span class="ss">@latest"</span>,</span>
<span id="cb136-261"><a href="#cb136-261" aria-hidden="true" tabindex="-1"></a>            display_name<span class="op">=</span><span class="st">"inference"</span>,</span>
<span id="cb136-262"><a href="#cb136-262" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-263"><a href="#cb136-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-264"><a href="#cb136-264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Instantiation</span></span>
<span id="cb136-265"><a href="#cb136-265" aria-hidden="true" tabindex="-1"></a>        inference_job <span class="op">=</span> inference_component(</span>
<span id="cb136-266"><a href="#cb136-266" aria-hidden="true" tabindex="-1"></a>            preprocessed_input_folder<span class="op">=</span>preprocessing_test_job.outputs.output_folder,</span>
<span id="cb136-267"><a href="#cb136-267" aria-hidden="true" tabindex="-1"></a>            preprocessed_input_filename<span class="op">=</span>preprocessing_test_output_filename,</span>
<span id="cb136-268"><a href="#cb136-268" aria-hidden="true" tabindex="-1"></a>            model_input_folder<span class="op">=</span>training_job.outputs.output_folder,</span>
<span id="cb136-269"><a href="#cb136-269" aria-hidden="true" tabindex="-1"></a>            model_input_filename<span class="op">=</span>training_output_filename,</span>
<span id="cb136-270"><a href="#cb136-270" aria-hidden="true" tabindex="-1"></a>            <span class="co">#output_folder: automatically determined</span></span>
<span id="cb136-271"><a href="#cb136-271" aria-hidden="true" tabindex="-1"></a>            output_filename<span class="op">=</span>inference_output_filename,</span>
<span id="cb136-272"><a href="#cb136-272" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb136-273"><a href="#cb136-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-274"><a href="#cb136-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build pipeline </span></span>
<span id="cb136-275"><a href="#cb136-275" aria-hidden="true" tabindex="-1"></a>    three_components_pipeline_object <span class="op">=</span> three_components_pipeline(</span>
<span id="cb136-276"><a href="#cb136-276" aria-hidden="true" tabindex="-1"></a>        <span class="co"># first preprocessing component</span></span>
<span id="cb136-277"><a href="#cb136-277" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_training_input_file),</span>
<span id="cb136-278"><a href="#cb136-278" aria-hidden="true" tabindex="-1"></a>        preprocessing_training_output_filename<span class="op">=</span>config.preprocessing_training_output_filename,</span>
<span id="cb136-279"><a href="#cb136-279" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>config.x,</span>
<span id="cb136-280"><a href="#cb136-280" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb136-281"><a href="#cb136-281" aria-hidden="true" tabindex="-1"></a>        <span class="co"># second preprocessing component</span></span>
<span id="cb136-282"><a href="#cb136-282" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_input_file<span class="op">=</span>Input(<span class="bu">type</span><span class="op">=</span><span class="st">"uri_file"</span>, path<span class="op">=</span>config.preprocessing_test_input_file),</span>
<span id="cb136-283"><a href="#cb136-283" aria-hidden="true" tabindex="-1"></a>        preprocessing_test_output_filename<span class="op">=</span>config.preprocessing_test_output_filename,</span>
<span id="cb136-284"><a href="#cb136-284" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb136-285"><a href="#cb136-285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training component parameters:</span></span>
<span id="cb136-286"><a href="#cb136-286" aria-hidden="true" tabindex="-1"></a>        training_output_filename<span class="op">=</span>config.training_output_filename,</span>
<span id="cb136-287"><a href="#cb136-287" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb136-288"><a href="#cb136-288" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Inference component parameters:</span></span>
<span id="cb136-289"><a href="#cb136-289" aria-hidden="true" tabindex="-1"></a>        inference_output_filename<span class="op">=</span>config.inference_output_filename,</span>
<span id="cb136-290"><a href="#cb136-290" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-291"><a href="#cb136-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-292"><a href="#cb136-292" aria-hidden="true" tabindex="-1"></a>    connect_setup_and_run (</span>
<span id="cb136-293"><a href="#cb136-293" aria-hidden="true" tabindex="-1"></a>        three_components_pipeline_object, </span>
<span id="cb136-294"><a href="#cb136-294" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb136-295"><a href="#cb136-295" aria-hidden="true" tabindex="-1"></a>        compute_name<span class="op">=</span>config.compute_name,</span>
<span id="cb136-296"><a href="#cb136-296" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>config.image,</span>
<span id="cb136-297"><a href="#cb136-297" aria-hidden="true" tabindex="-1"></a>        conda_file<span class="op">=</span>config.conda_file,</span>
<span id="cb136-298"><a href="#cb136-298" aria-hidden="true" tabindex="-1"></a>        name_env<span class="op">=</span>config.name_env,</span>
<span id="cb136-299"><a href="#cb136-299" aria-hidden="true" tabindex="-1"></a>        description_env<span class="op">=</span>config.description_env,</span>
<span id="cb136-300"><a href="#cb136-300" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-301"><a href="#cb136-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-302"><a href="#cb136-302" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-303"><a href="#cb136-303" aria-hidden="true" tabindex="-1"></a><span class="co"># Parsing</span></span>
<span id="cb136-304"><a href="#cb136-304" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-305"><a href="#cb136-305" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args ():</span>
<span id="cb136-306"><a href="#cb136-306" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses input arguments"""</span></span>
<span id="cb136-307"><a href="#cb136-307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb136-308"><a href="#cb136-308" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb136-309"><a href="#cb136-309" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb136-310"><a href="#cb136-310" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--config-path"</span>, </span>
<span id="cb136-311"><a href="#cb136-311" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb136-312"><a href="#cb136-312" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"pipeline_input.json"</span>,</span>
<span id="cb136-313"><a href="#cb136-313" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Path to config file specifying pipeline input parameters."</span>,</span>
<span id="cb136-314"><a href="#cb136-314" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-315"><a href="#cb136-315" aria-hidden="true" tabindex="-1"></a>    parser.add_argument (</span>
<span id="cb136-316"><a href="#cb136-316" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--experiment-name"</span>, </span>
<span id="cb136-317"><a href="#cb136-317" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, </span>
<span id="cb136-318"><a href="#cb136-318" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="st">"hello-world-experiment"</span>,</span>
<span id="cb136-319"><a href="#cb136-319" aria-hidden="true" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of experiment."</span>,</span>
<span id="cb136-320"><a href="#cb136-320" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-321"><a href="#cb136-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-322"><a href="#cb136-322" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb136-323"><a href="#cb136-323" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb136-324"><a href="#cb136-324" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">"Running hello-world pipeline with args"</span>, args)</span>
<span id="cb136-325"><a href="#cb136-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb136-326"><a href="#cb136-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> args</span>
<span id="cb136-327"><a href="#cb136-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-328"><a href="#cb136-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-329"><a href="#cb136-329" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-330"><a href="#cb136-330" aria-hidden="true" tabindex="-1"></a><span class="co"># main</span></span>
<span id="cb136-331"><a href="#cb136-331" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-332"><a href="#cb136-332" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main ():</span>
<span id="cb136-333"><a href="#cb136-333" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parses arguments and runs pipeline"""</span></span>
<span id="cb136-334"><a href="#cb136-334" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args ()</span>
<span id="cb136-335"><a href="#cb136-335" aria-hidden="true" tabindex="-1"></a>    run_pipeline (</span>
<span id="cb136-336"><a href="#cb136-336" aria-hidden="true" tabindex="-1"></a>        args.config_path,</span>
<span id="cb136-337"><a href="#cb136-337" aria-hidden="true" tabindex="-1"></a>        args.experiment_name,</span>
<span id="cb136-338"><a href="#cb136-338" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb136-339"><a href="#cb136-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-340"><a href="#cb136-340" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-341"><a href="#cb136-341" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb136-342"><a href="#cb136-342" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb136-343"><a href="#cb136-343" aria-hidden="true" tabindex="-1"></a>    main ()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting hello_world_pipeline.py</code></pre>
</div>
</div>
<div id="fe27bc97-8349-4243-8f51-cd1062bf2b95" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>run hello_world_pipeline.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found the config file in: /config.json</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running hello-world pipeline with args Namespace(config_path='pipeline_input.json', experiment_name='hello-world-experiment')
using hello-world@latest
RunId: lucid_napkin_t6nkwzqqfx
Web View: https://ml.azure.com/runs/lucid_napkin_t6nkwzqqfx?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld

Streaming logs/azureml/executionlogs.txt
========================================

[2024-04-10 09:42:21Z] Submitting 2 runs, first five are: a13baad8:2e78988c-ec3d-42c7-ad94-54617bee7252,e9a47e09:b17a6162-ff6c-48a3-af00-becc887c58d8
[2024-04-10 09:42:43Z] Completing processing run id 2e78988c-ec3d-42c7-ad94-54617bee7252.
[2024-04-10 09:42:54Z] Completing processing run id b17a6162-ff6c-48a3-af00-becc887c58d8.
[2024-04-10 09:42:55Z] Submitting 1 runs, first five are: 9e02ee11:40379116-e551-49fa-b02b-8af7678e75e4
[2024-04-10 09:43:16Z] Completing processing run id 40379116-e551-49fa-b02b-8af7678e75e4.
[2024-04-10 09:43:17Z] Submitting 1 runs, first five are: 01e4367a:e69290f9-ce7c-4946-a3b9-db4b0ab5ad0a
[2024-04-10 09:43:38Z] Completing processing run id e69290f9-ce7c-4946-a3b9-db4b0ab5ad0a.

Execution Summary
=================
RunId: lucid_napkin_t6nkwzqqfx
Web View: https://ml.azure.com/runs/lucid_napkin_t6nkwzqqfx?wsid=/subscriptions/6af6741b-f140-48c2-84ca-027a27365026/resourcegroups/helloworld/workspaces/helloworld
</code></pre>
</div>
</div>
<section id="debugging" class="level3">
<h3 class="anchored" data-anchor-id="debugging">Debugging</h3>
<div id="a8631516-99d3-4169-aa4f-4851ffbf7f66" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mydec (f):</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mywrap (<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">"hello"</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>        f()</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">"bye"</span>)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mywrap</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> outerf ():</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@mydec</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> myf ():</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="ss">f"myf: </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>    myf()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4f86cad5-1906-4f41-ac28-4fa409d3313a" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>outerf()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello
myf: 3
bye</code></pre>
</div>
</div>
<div id="a6cc0a7c-5077-4a9c-be3b-4bb4c05eb6b7" class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co">'${{parent.inputs.name_env}}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9bfcb801-2405-4ee1-a14e-59bd5d2c1240" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hello_world_pipeline <span class="im">import</span> <span class="ex">connect</span>, create_env, read_config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6026ba04-12c9-4b3d-af99-24ab2439d2bf" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>ml_client <span class="op">=</span> <span class="ex">connect</span> ()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found the config file in: /config.json</code></pre>
</div>
</div>
<div id="6878f200-38d2-4cac-acde-aa4054fb39c7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> read_config (<span class="st">"./pipeline_input.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ed412488-28b6-48dd-b134-f05c880cba84" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>create_env (</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>    ml_client, </span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>    config.image,</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    config.conda_file,</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    config.name_env,</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    config.description_env,</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Found the config file in: /config.json</code></pre>
</div>
</div>
<div id="ea11965a-3767-465d-9acc-d509830a3b3f" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span>ml_client.environments.get (config.name_env, version<span class="op">=</span><span class="st">"1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a1902e11-2ac9-4252-9864-0a77c577758d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>x.name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>'hello-world'</code></pre>
</div>
</div>
<div id="d6b9bac2-ff7d-42dd-a3ee-806f9b75fa24" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>config.name_env</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>'hello-world'</code></pre>
</div>
</div>
<div id="e89d4537-2393-4677-9812-b85a82dabeca" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>x.version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>'1'</code></pre>
</div>
</div>
</section>
</section>
<section id="further-refactorings" class="level2">
<h2 class="anchored" data-anchor-id="further-refactorings">Further refactorings</h2>
<ul>
<li>Create more structure on config input file: one dictionary per pipeline component.</li>
</ul>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<ul>
<li>Create components using <code>@command_component</code> decorator, see https://learn.microsoft.com/en-us/azure/machine-learning/how-to-create-component-pipeline-python?view=azureml-api-2#create-components-for-building-pipeline</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/JaumeAmoresDS\.github\.io\/home\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="beatrizmilz/blog-en" data-repo-id="R_kgDOHc0DoQ" data-category="General" data-category-id="DIC_kwDOHc0Doc4CPeUR" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2023 Jaume Amores.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>